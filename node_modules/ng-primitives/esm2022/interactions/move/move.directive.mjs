import { booleanAttribute, Directive, HostListener, input, output, signal } from '@angular/core';
import { injectDisabled } from 'ng-primitives/internal';
import { injectDisposables } from 'ng-primitives/utils';
import { NgpMoveToken } from './move.token';
import * as i0 from "@angular/core";
/**
 * Inspired by react-aria useMove hook:
 * https://github.com/adobe/react-spectrum/blob/main/packages/%40react-aria/interactions/src/useMove.ts
 */
export class NgpMove {
    constructor() {
        /**
         * Access the disposable helper.
         */
        this.disposables = injectDisposables();
        /**
         * Whether movement is disabled.
         */
        this.disabled = input(false, {
            alias: 'ngpMoveDisabled',
            transform: booleanAttribute,
        });
        /**
         * Access the disabled state from any parent.
         */
        this.isDisabled = injectDisabled(this.disabled);
        /**
         * Emit when the move event begins.
         */
        this.start = output({
            alias: 'ngpMoveStart',
        });
        /**
         * Emit when the element is moved.
         */
        this.move = output({
            alias: 'ngpMove',
        });
        /**
         * Emit when the move event ends.
         */
        this.end = output({
            alias: 'ngpMoveEnd',
        });
        /**
         * Whether the element is currently being moved.
         */
        this.isMoving = signal(false);
        /**
         * Store the last x position of the element.
         */
        this.x = null;
        /**
         * Store the last y position of the element.
         */
        this.y = null;
        /**
         * Store the id of the last pointer.
         */
        this.pointerId = null;
        /**
         * Store the disposable event listeners.
         */
        this.disposableListeners = [];
    }
    /**
     * Handle a move start.
     */
    onMoveStart(event, pointerType) {
        this.start.emit({
            pointerType,
            shiftKey: event.shiftKey,
            ctrlKey: event.ctrlKey,
            metaKey: event.metaKey,
            altKey: event.altKey,
        });
        this.isMoving.set(true);
    }
    /**
     * Handle a move event.
     */
    onMove(event, pointerType, deltaX, deltaY) {
        if (deltaX === 0 && deltaY === 0) {
            return;
        }
        this.move.emit({
            deltaX,
            deltaY,
            pointerType,
            shiftKey: event.shiftKey,
            ctrlKey: event.ctrlKey,
            metaKey: event.metaKey,
            altKey: event.altKey,
        });
    }
    /**
     * Handle a move end.
     */
    onMoveEnd(event, pointerType) {
        this.end.emit({
            pointerType,
            shiftKey: event.shiftKey,
            ctrlKey: event.ctrlKey,
            metaKey: event.metaKey,
            altKey: event.altKey,
        });
        this.isMoving.set(false);
    }
    /**
     * Handle the pointer down event.
     */
    onPointerDown(event) {
        // ignore right-click or additional pointers
        if (event.button !== 0 || this.pointerId !== null || this.isDisabled()) {
            return;
        }
        // prevent the default behavior
        event.preventDefault();
        event.stopPropagation();
        this.onMoveStart(event, event.pointerType);
        // store the pointer id and initial position
        this.pointerId = event.pointerId;
        this.x = event.pageX;
        this.y = event.pageY;
        // add global event listeners
        const pointerMove = this.disposables.addEventListener(window, 'pointermove', this.onPointerMove.bind(this), false);
        const pointerUp = this.disposables.addEventListener(window, 'pointerup', this.onPointerUp.bind(this), false);
        const pointerCancel = this.disposables.addEventListener(window, 'pointercancel', this.onPointerUp.bind(this), false);
        // store the disposable event listeners
        this.disposableListeners = [pointerMove, pointerUp, pointerCancel];
    }
    /**
     * Handle the pointer up event.
     */
    onPointerUp(event) {
        if (this.pointerId !== event.pointerId) {
            return;
        }
        const pointerType = (event.pointerType ?? 'mouse');
        this.onMoveEnd(event, pointerType);
        this.pointerId = null;
        this.disposableListeners.forEach(dispose => dispose());
    }
    /**
     * Handle the pointer move event.
     */
    onPointerMove(event) {
        if (this.pointerId !== event.pointerId) {
            return;
        }
        // Problems with PointerEvent#movementX/movementY:
        // 1. it is always 0 on macOS Safari.
        // 2. On Chrome Android, it's scaled by devicePixelRatio, but not on Chrome macOS
        this.onMove(event, event.pointerType, event.pageX - (this.x ?? 0), event.pageY - (this.y ?? 0));
        this.x = event.pageX;
        this.y = event.pageY;
    }
    triggerKeyboardMove(event, deltaX, deltaY) {
        if (this.isDisabled()) {
            return;
        }
        this.onMoveStart(event, 'keyboard');
        this.onMove(event, 'keyboard', deltaX, deltaY);
        this.onMoveEnd(event, 'keyboard');
    }
    onArrowUp(event) {
        event.preventDefault();
        event.stopPropagation();
        this.triggerKeyboardMove(event, 0, -1);
    }
    onArrowDown(event) {
        event.preventDefault();
        event.stopPropagation();
        this.triggerKeyboardMove(event, 0, 1);
    }
    onArrowLeft(event) {
        event.preventDefault();
        event.stopPropagation();
        this.triggerKeyboardMove(event, -1, 0);
    }
    onArrowRight(event) {
        event.preventDefault();
        event.stopPropagation();
        this.triggerKeyboardMove(event, 1, 0);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: NgpMove, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "17.1.0", version: "18.2.13", type: NgpMove, isStandalone: true, selector: "[ngpMove]", inputs: { disabled: { classPropertyName: "disabled", publicName: "ngpMoveDisabled", isSignal: true, isRequired: false, transformFunction: null } }, outputs: { start: "ngpMoveStart", move: "ngpMove", end: "ngpMoveEnd" }, host: { listeners: { "pointerdown": "onPointerDown($event)", "keydown.ArrowUp": "onArrowUp($event)", "keydown.ArrowDown": "onArrowDown($event)", "keydown.ArrowLeft": "onArrowLeft($event)", "keydown.ArrowRight": "onArrowRight($event)" }, properties: { "attr.data-move": "isMoving() ? \"\" : null" } }, providers: [{ provide: NgpMoveToken, useExisting: NgpMove }], exportAs: ["ngpMove"], ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: NgpMove, decorators: [{
            type: Directive,
            args: [{
                    standalone: true,
                    selector: '[ngpMove]',
                    exportAs: 'ngpMove',
                    providers: [{ provide: NgpMoveToken, useExisting: NgpMove }],
                    host: {
                        '[attr.data-move]': 'isMoving() ? "" : null',
                    },
                }]
        }], propDecorators: { onPointerDown: [{
                type: HostListener,
                args: ['pointerdown', ['$event']]
            }], onArrowUp: [{
                type: HostListener,
                args: ['keydown.ArrowUp', ['$event']]
            }], onArrowDown: [{
                type: HostListener,
                args: ['keydown.ArrowDown', ['$event']]
            }], onArrowLeft: [{
                type: HostListener,
                args: ['keydown.ArrowLeft', ['$event']]
            }], onArrowRight: [{
                type: HostListener,
                args: ['keydown.ArrowRight', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW92ZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9uZy1wcmltaXRpdmVzL2ludGVyYWN0aW9ucy9zcmMvbW92ZS9tb3ZlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFRQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGNBQWMsQ0FBQzs7QUFFNUM7OztHQUdHO0FBV0gsTUFBTSxPQUFPLE9BQU87SUFUcEI7UUFVRTs7V0FFRztRQUNjLGdCQUFXLEdBQUcsaUJBQWlCLEVBQUUsQ0FBQztRQUVuRDs7V0FFRztRQUNNLGFBQVEsR0FBRyxLQUFLLENBQXdCLEtBQUssRUFBRTtZQUN0RCxLQUFLLEVBQUUsaUJBQWlCO1lBQ3hCLFNBQVMsRUFBRSxnQkFBZ0I7U0FDNUIsQ0FBQyxDQUFDO1FBRUg7O1dBRUc7UUFDYyxlQUFVLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUU1RDs7V0FFRztRQUNNLFVBQUssR0FBRyxNQUFNLENBQW9CO1lBQ3pDLEtBQUssRUFBRSxjQUFjO1NBQ3RCLENBQUMsQ0FBQztRQUVIOztXQUVHO1FBQ00sU0FBSSxHQUFHLE1BQU0sQ0FBZTtZQUNuQyxLQUFLLEVBQUUsU0FBUztTQUNqQixDQUFDLENBQUM7UUFFSDs7V0FFRztRQUNNLFFBQUcsR0FBRyxNQUFNLENBQWtCO1lBQ3JDLEtBQUssRUFBRSxZQUFZO1NBQ3BCLENBQUMsQ0FBQztRQUVIOztXQUVHO1FBQ0ssYUFBUSxHQUFHLE1B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RUFBRSxDQUFDLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBR1MsWUFBWSxDQUFDLEtBQW9CO1FBQ3pDLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QixLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDeEMsQ0FBQzsrR0EzT1UsT0FBTzttR0FBUCxPQUFPLGlrQkFMUCxDQUFDLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFLENBQUM7OzRGQUtqRCxPQUFPO2tCQVRuQixTQUFTO21CQUFDO29CQUNULFVBQVUsRUFBRSxJQUFJO29CQUNoQixRQUFRLEVBQUUsV0FBVztvQkFDckIsUUFBUSxFQUFFLFNBQVM7b0JBQ25CLFNBQVMsRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLFNBQVMsRUFBRSxDQUFDO29CQUM1RCxJQUFJLEVBQUU7d0JBQ0osa0JBQWtCLEVBQUUsd0JBQXdCO3FCQUM3QztpQkFDRjs4QkEwSFcsYUFBYTtzQkFEdEIsWUFBWTt1QkFBQyxhQUFhLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0JBMEY3QixTQUFTO3NCQURsQixZQUFZO3VCQUFDLGlCQUFpQixFQUFFLENBQUMsUUFBUSxDQUFDO2dCQVFqQyxXQUFXO3NCQURwQixZQUFZO3VCQUFDLG1CQUFtQixFQUFFLENBQUMsUUFBUSxDQUFDO2dCQVFuQyxXQUFXO3NCQURwQixZQUFZO3VCQUFDLG1CQUFtQixFQUFFLENBQUMsUUFBUSxDQUFDO2dCQVFuQyxZQUFZO3NCQURyQixZQUFZO3VCQUFDLG9CQUFvQixFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgwqkgMjAyNCBBbmd1bGFyIFByaW1pdGl2ZXMuXG4gKiBodHRwczovL2dpdGh1Yi5jb20vbmctcHJpbWl0aXZlcy9uZy1wcmltaXRpdmVzXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIDIuMCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5pbXBvcnQgeyBCb29sZWFuSW5wdXQgfSBmcm9tICdAYW5ndWxhci9jZGsvY29lcmNpb24nO1xuaW1wb3J0IHsgYm9vbGVhbkF0dHJpYnV0ZSwgRGlyZWN0aXZlLCBIb3N0TGlzdGVuZXIsIGlucHV0LCBvdXRwdXQsIHNpZ25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgaW5qZWN0RGlzYWJsZWQgfSBmcm9tICduZy1wcmltaXRpdmVzL2ludGVybmFsJztcbmltcG9ydCB7IGluamVjdERpc3Bvc2FibGVzIH0gZnJvbSAnbmctcHJpbWl0aXZlcy91dGlscyc7XG5pbXBvcnQgeyBOZ3BNb3ZlVG9rZW4gfSBmcm9tICcuL21vdmUudG9rZW4nO1xuXG4vKipcbiAqIEluc3BpcmVkIGJ5IHJlYWN0LWFyaWEgdXNlTW92ZSBob29rOlxuICogaHR0cHM6Ly9naXRodWIuY29tL2Fkb2JlL3JlYWN0LXNwZWN0cnVtL2Jsb2IvbWFpbi9wYWNrYWdlcy8lNDByZWFjdC1hcmlhL2ludGVyYWN0aW9ucy9zcmMvdXNlTW92ZS50c1xuICovXG5cbkBEaXJlY3RpdmUoe1xuICBzdGFuZGFsb25lOiB0cnVlLFxuICBzZWxlY3RvcjogJ1tuZ3BNb3ZlXScsXG4gIGV4cG9ydEFzOiAnbmdwTW92ZScsXG4gIHByb3ZpZGVyczogW3sgcHJvdmlkZTogTmdwTW92ZVRva2VuLCB1c2VFeGlzdGluZzogTmdwTW92ZSB9XSxcbiAgaG9zdDoge1xuICAgICdbYXR0ci5kYXRhLW1vdmVdJzogJ2lzTW92aW5nKCkgPyBcIlwiIDogbnVsbCcsXG4gIH0sXG59KVxuZXhwb3J0IGNsYXNzIE5ncE1vdmUge1xuICAvKipcbiAgICogQWNjZXNzIHRoZSBkaXNwb3NhYmxlIGhlbHBlci5cbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgZGlzcG9zYWJsZXMgPSBpbmplY3REaXNwb3NhYmxlcygpO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIG1vdmVtZW50IGlzIGRpc2FibGVkLlxuICAgKi9cbiAgcmVhZG9ubHkgZGlzYWJsZWQgPSBpbnB1dDxib29sZWFuLCBCb29sZWFuSW5wdXQ+KGZhbHNlLCB7XG4gICAgYWxpYXM6ICduZ3BNb3ZlRGlzYWJsZWQnLFxuICAgIHRyYW5zZm9ybTogYm9vbGVhbkF0dHJpYnV0ZSxcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEFjY2VzcyB0aGUgZGlzYWJsZWQgc3RhdGUgZnJvbSBhbnkgcGFyZW50LlxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBpc0Rpc2FibGVkID0gaW5qZWN0RGlzYWJsZWQodGhpcy5kaXNhYmxlZCk7XG5cbiAgLyoqXG4gICAqIEVtaXQgd2hlbiB0aGUgbW92ZSBldmVudCBiZWdpbnMuXG4gICAqL1xuICByZWFkb25seSBzdGFydCA9IG91dHB1dDxOZ3BNb3ZlU3RhcnRFdmVudD4oe1xuICAgIGFsaWFzOiAnbmdwTW92ZVN0YXJ0JyxcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEVtaXQgd2hlbiB0aGUgZWxlbWVudCBpcyBtb3ZlZC5cbiAgICovXG4gIHJlYWRvbmx5IG1vdmUgPSBvdXRwdXQ8TmdwTW92ZUV2ZW50Pih7XG4gICAgYWxpYXM6ICduZ3BNb3ZlJyxcbiAgfSk7XG5cbiAgLyoqXG4gICAqIEVtaXQgd2hlbiB0aGUgbW92ZSBldmVudCBlbmRzLlxuICAgKi9cbiAgcmVhZG9ubHkgZW5kID0gb3V0cHV0PE5ncE1vdmVFbmRFdmVudD4oe1xuICAgIGFsaWFzOiAnbmdwTW92ZUVuZCcsXG4gIH0pO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoZSBlbGVtZW50IGlzIGN1cnJlbnRseSBiZWluZyBtb3ZlZC5cbiAgICovXG4gIHByaXZhdGUgaXNNb3ZpbmcgPSBzaWduYWw8Ym9vbGVhbj4oZmFsc2UpO1xuXG4gIC8qKlxuICAgKiBTdG9yZSB0aGUgbGFzdCB4IHBvc2l0aW9uIG9mIHRoZSBlbGVtZW50LlxuICAgKi9cbiAgcHJpdmF0ZSB4OiBudW1iZXIgfCBudWxsID0gbnVsbDtcblxuICAvKipcbiAgICogU3RvcmUgdGhlIGxhc3QgeSBwb3NpdGlvbiBvZiB0aGUgZWxlbWVudC5cbiAgICovXG4gIHByaXZhdGUgeTogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG5cbiAgLyoqXG4gICAqIFN0b3JlIHRoZSBpZCBvZiB0aGUgbGFzdCBwb2ludGVyLlxuICAgKi9cbiAgcHJpdmF0ZSBwb2ludGVySWQ6IG51bWJlciB8IG51bGwgPSBudWxsO1xuXG4gIC8qKlxuICAgKiBTdG9yZSB0aGUgZGlzcG9zYWJsZSBldmVudCBsaXN0ZW5lcnMuXG4gICAqL1xuICBwcml2YXRlIGRpc3Bvc2FibGVMaXN0ZW5lcnM6ICgoKSA9PiB2b2lkKVtdID0gW107XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBhIG1vdmUgc3RhcnQuXG4gICAqL1xuICBwcml2YXRlIG9uTW92ZVN0YXJ0KGV2ZW50OiBQb2ludGVyRXZlbnQgfCBLZXlib2FyZEV2ZW50LCBwb2ludGVyVHlwZTogUG9pbnRlclR5cGUpOiB2b2lkIHtcbiAgICB0aGlzLnN0YXJ0LmVtaXQoe1xuICAgICAgcG9pbnRlclR5cGUsXG4gICAgICBzaGlmdEtleTogZXZlbnQuc2hpZnRLZXksXG4gICAgICBjdHJsS2V5OiBldmVudC5jdHJsS2V5LFxuICAgICAgbWV0YUtleTogZXZlbnQubWV0YUtleSxcbiAgICAgIGFsdEtleTogZXZlbnQuYWx0S2V5LFxuICAgIH0pO1xuICAgIHRoaXMuaXNNb3Zpbmcuc2V0KHRydWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBhIG1vdmUgZXZlbnQuXG4gICAqL1xuICBwcml2YXRlIG9uTW92ZShcbiAgICBldmVudDogUG9pbnRlckV2ZW50IHwgS2V5Ym9hcmRFdmVudCxcbiAgICBwb2ludGVyVHlwZTogUG9pbnRlclR5cGUsXG4gICAgZGVsdGFYOiBudW1iZXIsXG4gICAgZGVsdGFZOiBudW1iZXIsXG4gICk6IHZvaWQge1xuICAgIGlmIChkZWx0YVggPT09IDAgJiYgZGVsdGFZID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5tb3ZlLmVtaXQoe1xuICAgICAgZGVsdGFYLFxuICAgICAgZGVsdGFZLFxuICAgICAgcG9pbnRlclR5cGUsXG4gICAgICBzaGlmdEtleTogZXZlbnQuc2hpZnRLZXksXG4gICAgICBjdHJsS2V5OiBldmVudC5jdHJsS2V5LFxuICAgICAgbWV0YUtleTogZXZlbnQubWV0YUtleSxcbiAgICAgIGFsdEtleTogZXZlbnQuYWx0S2V5LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBhIG1vdmUgZW5kLlxuICAgKi9cbiAgcHJpdmF0ZSBvbk1vdmVFbmQoZXZlbnQ6IFBvaW50ZXJFdmVudCB8IEtleWJvYXJkRXZlbnQsIHBvaW50ZXJUeXBlOiBQb2ludGVyVHlwZSk6IHZvaWQge1xuICAgIHRoaXMuZW5kLmVtaXQoe1xuICAgICAgcG9pbnRlclR5cGUsXG4gICAgICBzaGlmdEtleTogZXZlbnQuc2hpZnRLZXksXG4gICAgICBjdHJsS2V5OiBldmVudC5jdHJsS2V5LFxuICAgICAgbWV0YUtleTogZXZlbnQubWV0YUtleSxcbiAgICAgIGFsdEtleTogZXZlbnQuYWx0S2V5LFxuICAgIH0pO1xuICAgIHRoaXMuaXNNb3Zpbmcuc2V0KGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgdGhlIHBvaW50ZXIgZG93biBldmVudC5cbiAgICovXG4gIEBIb3N0TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgWyckZXZlbnQnXSlcbiAgcHJvdGVjdGVkIG9uUG9pbnRlckRvd24oZXZlbnQ6IFBvaW50ZXJFdmVudCk6IHZvaWQge1xuICAgIC8vIGlnbm9yZSByaWdodC1jbGljayBvciBhZGRpdGlvbmFsIHBvaW50ZXJzXG4gICAgaWYgKGV2ZW50LmJ1dHRvbiAhPT0gMCB8fCB0aGlzLnBvaW50ZXJJZCAhPT0gbnVsbCB8fCB0aGlzLmlzRGlzYWJsZWQoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIHByZXZlbnQgdGhlIGRlZmF1bHQgYmVoYXZpb3JcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgdGhpcy5vbk1vdmVTdGFydChldmVudCwgZXZlbnQucG9pbnRlclR5cGUgYXMgUG9pbnRlclR5cGUpO1xuXG4gICAgLy8gc3RvcmUgdGhlIHBvaW50ZXIgaWQgYW5kIGluaXRpYWwgcG9zaXRpb25cbiAgICB0aGlzLnBvaW50ZXJJZCA9IGV2ZW50LnBvaW50ZXJJZDtcbiAgICB0aGlzLnggPSBldmVudC5wYWdlWDtcbiAgICB0aGlzLnkgPSBldmVudC5wYWdlWTtcblxuICAgIC8vIGFkZCBnbG9iYWwgZXZlbnQgbGlzdGVuZXJzXG4gICAgY29uc3QgcG9pbnRlck1vdmUgPSB0aGlzLmRpc3Bvc2FibGVzLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICB3aW5kb3csXG4gICAgICAncG9pbnRlcm1vdmUnLFxuICAgICAgdGhpcy5vblBvaW50ZXJNb3ZlLmJpbmQodGhpcykgYXMgRXZlbnRMaXN0ZW5lcixcbiAgICAgIGZhbHNlLFxuICAgICk7XG5cbiAgICBjb25zdCBwb2ludGVyVXAgPSB0aGlzLmRpc3Bvc2FibGVzLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICB3aW5kb3csXG4gICAgICAncG9pbnRlcnVwJyxcbiAgICAgIHRoaXMub25Qb2ludGVyVXAuYmluZCh0aGlzKSBhcyBFdmVudExpc3RlbmVyLFxuICAgICAgZmFsc2UsXG4gICAgKTtcblxuICAgIGNvbnN0IHBvaW50ZXJDYW5jZWwgPSB0aGlzLmRpc3Bvc2FibGVzLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICB3aW5kb3csXG4gICAgICAncG9pbnRlcmNhbmNlbCcsXG4gICAgICB0aGlzLm9uUG9pbnRlclVwLmJpbmQodGhpcykgYXMgRXZlbnRMaXN0ZW5lcixcbiAgICAgIGZhbHNlLFxuICAgICk7XG5cbiAgICAvLyBzdG9yZSB0aGUgZGlzcG9zYWJsZSBldmVudCBsaXN0ZW5lcnNcbiAgICB0aGlzLmRpc3Bvc2FibGVMaXN0ZW5lcnMgPSBbcG9pbnRlck1vdmUsIHBvaW50ZXJVcCwgcG9pbnRlckNhbmNlbF07XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlIHRoZSBwb2ludGVyIHVwIGV2ZW50LlxuICAgKi9cbiAgcHJvdGVjdGVkIG9uUG9pbnRlclVwKGV2ZW50OiBQb2ludGVyRXZlbnQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5wb2ludGVySWQgIT09IGV2ZW50LnBvaW50ZXJJZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHBvaW50ZXJUeXBlID0gKGV2ZW50LnBvaW50ZXJUeXBlID8/ICdtb3VzZScpIGFzIFBvaW50ZXJUeXBlO1xuICAgIHRoaXMub25Nb3ZlRW5kKGV2ZW50LCBwb2ludGVyVHlwZSk7XG4gICAgdGhpcy5wb2ludGVySWQgPSBudWxsO1xuICAgIHRoaXMuZGlzcG9zYWJsZUxpc3RlbmVycy5mb3JFYWNoKGRpc3Bvc2UgPT4gZGlzcG9zZSgpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgdGhlIHBvaW50ZXIgbW92ZSBldmVudC5cbiAgICovXG4gIHByb3RlY3RlZCBvblBvaW50ZXJNb3ZlKGV2ZW50OiBQb2ludGVyRXZlbnQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5wb2ludGVySWQgIT09IGV2ZW50LnBvaW50ZXJJZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFByb2JsZW1zIHdpdGggUG9pbnRlckV2ZW50I21vdmVtZW50WC9tb3ZlbWVudFk6XG4gICAgLy8gMS4gaXQgaXMgYWx3YXlzIDAgb24gbWFjT1MgU2FmYXJpLlxuICAgIC8vIDIuIE9uIENocm9tZSBBbmRyb2lkLCBpdCdzIHNjYWxlZCBieSBkZXZpY2VQaXhlbFJhdGlvLCBidXQgbm90IG9uIENocm9tZSBtYWNPU1xuICAgIHRoaXMub25Nb3ZlKFxuICAgICAgZXZlbnQsXG4gICAgICBldmVudC5wb2ludGVyVHlwZSBhcyBQb2ludGVyVHlwZSxcbiAgICAgIGV2ZW50LnBhZ2VYIC0gKHRoaXMueCA/PyAwKSxcbiAgICAgIGV2ZW50LnBhZ2VZIC0gKHRoaXMueSA/PyAwKSxcbiAgICApO1xuICAgIHRoaXMueCA9IGV2ZW50LnBhZ2VYO1xuICAgIHRoaXMueSA9IGV2ZW50LnBhZ2VZO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmlnZ2VyS2V5Ym9hcmRNb3ZlKGV2ZW50OiBLZXlib2FyZEV2ZW50LCBkZWx0YVg6IG51bWJlciwgZGVsdGFZOiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc0Rpc2FibGVkKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLm9uTW92ZVN0YXJ0KGV2ZW50LCAna2V5Ym9hcmQnKTtcbiAgICB0aGlzLm9uTW92ZShldmVudCwgJ2tleWJvYXJkJywgZGVsdGFYLCBkZWx0YVkpO1xuICAgIHRoaXMub25Nb3ZlRW5kKGV2ZW50LCAna2V5Ym9hcmQnKTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24uQXJyb3dVcCcsIFsnJGV2ZW50J10pXG4gIHByb3RlY3RlZCBvbkFycm93VXAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpOiB2b2lkIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMudHJpZ2dlcktleWJvYXJkTW92ZShldmVudCwgMCwgLTEpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5BcnJvd0Rvd24nLCBbJyRldmVudCddKVxuICBwcm90ZWN0ZWQgb25BcnJvd0Rvd24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpOiB2b2lkIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMudHJpZ2dlcktleWJvYXJkTW92ZShldmVudCwgMCwgMSk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdrZXlkb3duLkFycm93TGVmdCcsIFsnJGV2ZW50J10pXG4gIHByb3RlY3RlZCBvbkFycm93TGVmdChldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy50cmlnZ2VyS2V5Ym9hcmRNb3ZlKGV2ZW50LCAtMSwgMCk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdrZXlkb3duLkFycm93UmlnaHQnLCBbJyRldmVudCddKVxuICBwcm90ZWN0ZWQgb25BcnJvd1JpZ2h0KGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLnRyaWdnZXJLZXlib2FyZE1vdmUoZXZlbnQsIDEsIDApO1xuICB9XG59XG5cbmludGVyZmFjZSBOZ3BNb3ZlQmFzZUV2ZW50IHtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIGV2ZW50IHdhcyB0cmlnZ2VyZWQgYnkgYSBtb3VzZSBvciBrZXlib2FyZCBldmVudC5cbiAgICovXG4gIHBvaW50ZXJUeXBlOiBQb2ludGVyVHlwZTtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIHNoaWZ0IGtleSB3YXMgcHJlc3NlZCBkdXJpbmcgdGhlIGV2ZW50LlxuICAgKi9cbiAgc2hpZnRLZXk6IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoZSBjb250cm9sIGtleSB3YXMgcHJlc3NlZCBkdXJpbmcgdGhlIGV2ZW50LlxuICAgKi9cbiAgY3RybEtleTogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIG1ldGEga2V5IHdhcyBwcmVzc2VkIGR1cmluZyB0aGUgZXZlbnQuXG4gICAqL1xuICBtZXRhS2V5OiBib29sZWFuO1xuICAvKipcbiAgICogV2hldGhlciB0aGUgYWx0IGtleSB3YXMgcHJlc3NlZCBkdXJpbmcgdGhlIGV2ZW50LlxuICAgKi9cbiAgYWx0S2V5OiBib29sZWFuO1xufVxuXG5leHBvcnQgdHlwZSBOZ3BNb3ZlU3RhcnRFdmVudCA9IE5ncE1vdmVCYXNlRXZlbnQ7XG5leHBvcnQgdHlwZSBOZ3BNb3ZlRW5kRXZlbnQgPSBOZ3BNb3ZlQmFzZUV2ZW50O1xuXG5leHBvcnQgaW50ZXJmYWNlIE5ncE1vdmVFdmVudCBleHRlbmRzIE5ncE1vdmVCYXNlRXZlbnQge1xuICAvKipcbiAgICogVGhlIGFtb3VudCBvZiBwaXhlbHMgbW92ZWQgaW4gdGhlIHgtYXhpcy5cbiAgICovXG4gIGRlbHRhWDogbnVtYmVyO1xuICAvKipcbiAgICogVGhlIGFtb3VudCBvZiBwaXhlbHMgbW92ZWQgaW4gdGhlIHktYXhpcy5cbiAgICovXG4gIGRlbHRhWTogbnVtYmVyO1xufVxuXG5leHBvcnQgdHlwZSBQb2ludGVyVHlwZSA9ICdtb3VzZScgfCAncGVuJyB8ICd0b3VjaCcgfCAna2V5Ym9hcmQnIHwgJ3ZpcnR1YWwnO1xuIl19