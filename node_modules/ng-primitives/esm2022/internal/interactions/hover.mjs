/**
 * Copyright © 2024 Angular Primitives.
 * https://github.com/ng-primitives/ng-primitives
 *
 * This source code is licensed under the Apache 2.0 license found in the
 * LICENSE file in the root directory of this source tree.
 */
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { effect, ElementRef, inject, Injectable, PLATFORM_ID, signal } from '@angular/core';
import { injectDisposables, onBooleanChange } from 'ng-primitives/utils';
import * as i0 from "@angular/core";
/**
 * We use a service here as this value is a singleton
 * and allows us to register the dom events once.
 */
class GlobalPointerEvents {
    constructor() {
        /**
         * Whether global mouse events should be ignored.
         */
        this.ignoreEmulatedMouseEvents = false;
        /**
         * Access the document.
         */
        this.document = inject(DOCUMENT);
        /**
         * Determine the platform id.
         */
        this.platformId = inject(PLATFORM_ID);
        // we only want to setup events on the client
        if (isPlatformBrowser(this.platformId)) {
            this.setupGlobalTouchEvents();
        }
    }
    setupGlobalTouchEvents() {
        this.document.addEventListener('pointerup', this.handleGlobalPointerEvent.bind(this));
        this.document.addEventListener('touchend', this.setGlobalIgnoreEmulatedMouseEvents.bind(this));
    }
    setGlobalIgnoreEmulatedMouseEvents() {
        this.ignoreEmulatedMouseEvents = true;
        // Clear globalIgnoreEmulatedMouseEvents after a short timeout. iOS fires onPointerEnter
        // with pointerType="mouse" immediately after onPointerUp and before onFocus. On other
        // devices that don't have this quirk, we don't want to ignore a mouse hover sometime in
        // the distant future because a user previously touched the element.
        setTimeout(() => (this.ignoreEmulatedMouseEvents = false), 50);
    }
    handleGlobalPointerEvent(event) {
        if (event.pointerType === 'touch') {
            this.setGlobalIgnoreEmulatedMouseEvents();
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: GlobalPointerEvents, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: GlobalPointerEvents, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: GlobalPointerEvents, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [] });
/**
 * Programatically add the hover functionality to an element.
 * This is useful in cases where we can't necessarily use a HostDirective,
 * because there is a chance the directive has already been used.
 */
export function setupHover({ hoverStart, hoverEnd, disabled = signal(false), }) {
    /**
     * Access the element.
     */
    const elementRef = inject(ElementRef);
    /**
     * Access the global pointer events handler.
     */
    const globalPointerEvents = inject(GlobalPointerEvents);
    /**
     * Access the disposable helper.
     */
    const disposables = injectDisposables();
    /**
     * Store the current hover state.
     */
    const hovered = signal(false);
    /**
     * Whether this element should ignore emulated mouse events.
     */
    let ignoreEmulatedMouseEvents = false;
    /**
     * Setup event listeners.
     */
    disposables.addEventListener(elementRef.nativeElement, 'pointerenter', onPointerEnter);
    disposables.addEventListener(elementRef.nativeElement, 'pointerleave', onPointerLeave);
    disposables.addEventListener(elementRef.nativeElement, 'touchstart', onTouchStart);
    disposables.addEventListener(elementRef.nativeElement, 'mouseenter', onMouseEnter);
    disposables.addEventListener(elementRef.nativeElement, 'mouseleave', onMouseLeave);
    // anytime the disabled state changes to true, we must reset the hover state
    if (disabled) {
        onBooleanChange(disabled, reset);
    }
    // anytime the hover state changes we want to update the attribute
    effect(() => hovered()
        ? elementRef.nativeElement.setAttribute('data-hover', '')
        : elementRef.nativeElement.removeAttribute('data-hover'));
    /**
     * Reset the hover state.
     */
    function reset() {
        onHoverEnd('mouse');
    }
    /**
     * Trigger the hover start events.
     * @param event
     * @param pointerType
     */
    function onHoverStart(event, pointerType) {
        if (disabled() ||
            pointerType === 'touch' ||
            hovered() ||
            !event.currentTarget?.contains(event.target)) {
            return;
        }
        hovered.set(true);
        hoverStart?.();
    }
    /**
     * Trigger the hover end events.
     * @param pointerType
     */
    function onHoverEnd(pointerType) {
        if (pointerType === 'touch' || !hovered()) {
            return;
        }
        hovered.set(false);
        hoverEnd?.();
    }
    function onPointerEnter(event) {
        if (globalPointerEvents.ignoreEmulatedMouseEvents && event.pointerType === 'mouse') {
            return;
        }
        onHoverStart(event, event.pointerType);
    }
    function onPointerLeave(event) {
        if (!disabled() && event.currentTarget?.contains(event.target)) {
            onHoverEnd(event.pointerType);
        }
    }
    function onTouchStart() {
        ignoreEmulatedMouseEvents = true;
    }
    function onMouseEnter(event) {
        if (!ignoreEmulatedMouseEvents && !globalPointerEvents.ignoreEmulatedMouseEvents) {
            onHoverStart(event, 'mouse');
        }
        ignoreEmulatedMouseEvents = false;
    }
    function onMouseLeave(event) {
        if (!disabled() && event.currentTarget?.contains(event.target)) {
            onHoverEnd('mouse');
        }
    }
    return { hovered };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG92ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9uZy1wcmltaXRpdmVzL2ludGVybmFsL3NyYy9pbnRlcmFjdGlvbnMvaG92ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBQ0gsT0FBTyxFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzlELE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFVLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwRyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7O0FBRXpFOzs7R0FHRztBQUNILE1BR00sbUJBQW1CO0lBZ0J2QjtRQWZBOztXQUVHO1FBQ0gsOEJBQXlCLEdBQVksS0FBSyxDQUFDO1FBRTNDOztXQUVHO1FBQ2MsYUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUU3Qzs7V0FFRztRQUNjLGVBQVUsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7UUFHaEQsNkNBQTZDO1FBQzdDLElBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7WUFDdkMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUM7UUFDaEMsQ0FBQztJQUNILENBQUM7SUFFTyxzQkFBc0I7UUFDNUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3RGLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxrQ0FBa0MsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUNqRyxDQUFDO0lB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LE9BQU8sQ0FBQyxDQUFDO1FBQ3RCLENBQUM7SUFDSCxDQUFDO0lBRUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxDQUFDO0FBQ3JCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCDCqSAyMDI0IEFuZ3VsYXIgUHJpbWl0aXZlcy5cbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9uZy1wcmltaXRpdmVzL25nLXByaW1pdGl2ZXNcbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgMi4wIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cbmltcG9ydCB7IERPQ1VNRU5ULCBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBlZmZlY3QsIEVsZW1lbnRSZWYsIGluamVjdCwgSW5qZWN0YWJsZSwgUExBVEZPUk1fSUQsIFNpZ25hbCwgc2lnbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBpbmplY3REaXNwb3NhYmxlcywgb25Cb29sZWFuQ2hhbmdlIH0gZnJvbSAnbmctcHJpbWl0aXZlcy91dGlscyc7XG5cbi8qKlxuICogV2UgdXNlIGEgc2VydmljZSBoZXJlIGFzIHRoaXMgdmFsdWUgaXMgYSBzaW5nbGV0b25cbiAqIGFuZCBhbGxvd3MgdXMgdG8gcmVnaXN0ZXIgdGhlIGRvbSBldmVudHMgb25jZS5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuY2xhc3MgR2xvYmFsUG9pbnRlckV2ZW50cyB7XG4gIC8qKlxuICAgKiBXaGV0aGVyIGdsb2JhbCBtb3VzZSBldmVudHMgc2hvdWxkIGJlIGlnbm9yZWQuXG4gICAqL1xuICBpZ25vcmVFbXVsYXRlZE1vdXNlRXZlbnRzOiBib29sZWFuID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEFjY2VzcyB0aGUgZG9jdW1lbnQuXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGRvY3VtZW50ID0gaW5qZWN0KERPQ1VNRU5UKTtcblxuICAvKipcbiAgICogRGV0ZXJtaW5lIHRoZSBwbGF0Zm9ybSBpZC5cbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgcGxhdGZvcm1JZCA9IGluamVjdChQTEFURk9STV9JRCk7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgLy8gd2Ugb25seSB3YW50IHRvIHNldHVwIGV2ZW50cyBvbiB0aGUgY2xpZW50XG4gICAgaWYgKGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIHRoaXMuc2V0dXBHbG9iYWxUb3VjaEV2ZW50cygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBHbG9iYWxUb3VjaEV2ZW50cygpOiB2b2lkIHtcbiAgICB0aGlzLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJ1cCcsIHRoaXMuaGFuZGxlR2xvYmFsUG9pbnRlckV2ZW50LmJpbmQodGhpcykpO1xuICAgIHRoaXMuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLnNldEdsb2JhbElnbm9yZUVtdWxhdGVkTW91c2VFdmVudHMuYmluZCh0aGlzKSk7XG4gIH1cblxuICBwcml2YXRlIHNldEdsb2JhbElnbm9yZUVtdWxhdGVkTW91c2VFdmVudHMoKTogdm9pZCB7XG4gICAgdGhpcy5pZ25vcmVFbXVsYXRlZE1vdXNlRXZlbnRzID0gdHJ1ZTtcbiAgICAvLyBDbGVhciBnbG9iYWxJZ25vcmVFbXVsYXRlZE1vdXNlRXZlbnRzIGFmdGVyIGEgc2hvcnQgdGltZW91dC4gaU9TIGZpcmVzIG9uUG9pbnRlckVudGVyXG4gICAgLy8gd2l0aCBwb2ludGVyVHlwZT1cIm1vdXNlXCIgaW1tZWRpYXRlbHkgYWZ0ZXIgb25Qb2ludGVyVXAgYW5kIGJlZm9yZSBvbkZvY3VzLiBPbiBvdGhlclxuICAgIC8vIGRldmljZXMgdGhhdCBkb24ndCBoYXZlIHRoaXMgcXVpcmssIHdlIGRvbid0IHdhbnQgdG8gaWdub3JlIGEgbW91c2UgaG92ZXIgc29tZXRpbWUgaW5cbiAgICAvLyB0aGUgZGlzdGFudCBmdXR1cmUgYmVjYXVzZSBhIHVzZXIgcHJldmlvdXNseSB0b3VjaGVkIHRoZSBlbGVtZW50LlxuICAgIHNldFRpbWVvdXQoKCkgPT4gKHRoaXMuaWdub3JlRW11bGF0ZWRNb3VzZUV2ZW50cyA9IGZhbHNlKSwgNTApO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVHbG9iYWxQb2ludGVyRXZlbnQoZXZlbnQ6IFBvaW50ZXJFdmVudCk6IHZvaWQge1xuICAgIGlmIChldmVudC5wb2ludGVyVHlwZSA9PT0gJ3RvdWNoJykge1xuICAgICAgdGhpcy5zZXRHbG9iYWxJZ25vcmVFbXVsYXRlZE1vdXNlRXZlbnRzKCk7XG4gICAgfVxuICB9XG59XG5cbmludGVyZmFjZSBOZ3BIb3Zlck9wdGlvbnMge1xuICBkaXNhYmxlZD86IFNpZ25hbDxib29sZWFuPjtcbiAgaG92ZXJTdGFydD86ICgpID0+IHZvaWQ7XG4gIGhvdmVyRW5kPzogKCkgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOZ3BIb3ZlclN0YXRlIHtcbiAgaG92ZXJlZDogU2lnbmFsPGJvb2xlYW4+O1xufVxuXG4vKipcbiAqIFByb2dyYW1hdGljYWxseSBhZGQgdGhlIGhvdmVyIGZ1bmN0aW9uYWxpdHkgdG8gYW4gZWxlbWVudC5cbiAqIFRoaXMgaXMgdXNlZnVsIGluIGNhc2VzIHdoZXJlIHdlIGNhbid0IG5lY2Vzc2FyaWx5IHVzZSBhIEhvc3REaXJlY3RpdmUsXG4gKiBiZWNhdXNlIHRoZXJlIGlzIGEgY2hhbmNlIHRoZSBkaXJlY3RpdmUgaGFzIGFscmVhZHkgYmVlbiB1c2VkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBIb3Zlcih7XG4gIGhvdmVyU3RhcnQsXG4gIGhvdmVyRW5kLFxuICBkaXNhYmxlZCA9IHNpZ25hbChmYWxzZSksXG59OiBOZ3BIb3Zlck9wdGlvbnMpOiBOZ3BIb3ZlclN0YXRlIHtcbiAgLyoqXG4gICAqIEFjY2VzcyB0aGUgZWxlbWVudC5cbiAgICovXG4gIGNvbnN0IGVsZW1lbnRSZWYgPSBpbmplY3Q8RWxlbWVudFJlZjxIVE1MRWxlbWVudD4+KEVsZW1lbnRSZWYpO1xuXG4gIC8qKlxuICAgKiBBY2Nlc3MgdGhlIGdsb2JhbCBwb2ludGVyIGV2ZW50cyBoYW5kbGVyLlxuICAgKi9cbiAgY29uc3QgZ2xvYmFsUG9pbnRlckV2ZW50cyA9IGluamVjdChHbG9iYWxQb2ludGVyRXZlbnRzKTtcblxuICAvKipcbiAgICogQWNjZXNzIHRoZSBkaXNwb3NhYmxlIGhlbHBlci5cbiAgICovXG4gIGNvbnN0IGRpc3Bvc2FibGVzID0gaW5qZWN0RGlzcG9zYWJsZXMoKTtcblxuICAvKipcbiAgICogU3RvcmUgdGhlIGN1cnJlbnQgaG92ZXIgc3RhdGUuXG4gICAqL1xuICBjb25zdCBob3ZlcmVkID0gc2lnbmFsPGJvb2xlYW4+KGZhbHNlKTtcblxuICAvKipcbiAgICogV2hldGhlciB0aGlzIGVsZW1lbnQgc2hvdWxkIGlnbm9yZSBlbXVsYXRlZCBtb3VzZSBldmVudHMuXG4gICAqL1xuICBsZXQgaWdub3JlRW11bGF0ZWRNb3VzZUV2ZW50czogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBTZXR1cCBldmVudCBsaXN0ZW5lcnMuXG4gICAqL1xuICBkaXNwb3NhYmxlcy5hZGRFdmVudExpc3RlbmVyKGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ3BvaW50ZXJlbnRlcicsIG9uUG9pbnRlckVudGVyKTtcbiAgZGlzcG9zYWJsZXMuYWRkRXZlbnRMaXN0ZW5lcihlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdwb2ludGVybGVhdmUnLCBvblBvaW50ZXJMZWF2ZSk7XG4gIGRpc3Bvc2FibGVzLmFkZEV2ZW50TGlzdGVuZXIoZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAndG91Y2hzdGFydCcsIG9uVG91Y2hTdGFydCk7XG4gIGRpc3Bvc2FibGVzLmFkZEV2ZW50TGlzdGVuZXIoZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnbW91c2VlbnRlcicsIG9uTW91c2VFbnRlcik7XG4gIGRpc3Bvc2FibGVzLmFkZEV2ZW50TGlzdGVuZXIoZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnbW91c2VsZWF2ZScsIG9uTW91c2VMZWF2ZSk7XG5cbiAgLy8gYW55dGltZSB0aGUgZGlzYWJsZWQgc3RhdGUgY2hhbmdlcyB0byB0cnVlLCB3ZSBtdXN0IHJlc2V0IHRoZSBob3ZlciBzdGF0ZVxuICBpZiAoZGlzYWJsZWQpIHtcbiAgICBvbkJvb2xlYW5DaGFuZ2UoZGlzYWJsZWQsIHJlc2V0KTtcbiAgfVxuXG4gIC8vIGFueXRpbWUgdGhlIGhvdmVyIHN0YXRlIGNoYW5nZXMgd2Ugd2FudCB0byB1cGRhdGUgdGhlIGF0dHJpYnV0ZVxuICBlZmZlY3QoKCkgPT5cbiAgICBob3ZlcmVkKClcbiAgICAgID8gZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS1ob3ZlcicsICcnKVxuICAgICAgOiBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCdkYXRhLWhvdmVyJyksXG4gICk7XG5cbiAgLyoqXG4gICAqIFJlc2V0IHRoZSBob3ZlciBzdGF0ZS5cbiAgICovXG4gIGZ1bmN0aW9uIHJlc2V0KCk6IHZvaWQge1xuICAgIG9uSG92ZXJFbmQoJ21vdXNlJyk7XG4gIH1cblxuICAvKipcbiAgICogVHJpZ2dlciB0aGUgaG92ZXIgc3RhcnQgZXZlbnRzLlxuICAgKiBAcGFyYW0gZXZlbnRcbiAgICogQHBhcmFtIHBvaW50ZXJUeXBlXG4gICAqL1xuICBmdW5jdGlvbiBvbkhvdmVyU3RhcnQoZXZlbnQ6IEV2ZW50LCBwb2ludGVyVHlwZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgZGlzYWJsZWQoKSB8fFxuICAgICAgcG9pbnRlclR5cGUgPT09ICd0b3VjaCcgfHxcbiAgICAgIGhvdmVyZWQoKSB8fFxuICAgICAgIShldmVudC5jdXJyZW50VGFyZ2V0IGFzIEVsZW1lbnQpPy5jb250YWlucyhldmVudC50YXJnZXQgYXMgRWxlbWVudClcbiAgICApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBob3ZlcmVkLnNldCh0cnVlKTtcbiAgICBob3ZlclN0YXJ0Py4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUcmlnZ2VyIHRoZSBob3ZlciBlbmQgZXZlbnRzLlxuICAgKiBAcGFyYW0gcG9pbnRlclR5cGVcbiAgICovXG4gIGZ1bmN0aW9uIG9uSG92ZXJFbmQocG9pbnRlclR5cGU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChwb2ludGVyVHlwZSA9PT0gJ3RvdWNoJyB8fCAhaG92ZXJlZCgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaG92ZXJlZC5zZXQoZmFsc2UpO1xuICAgIGhvdmVyRW5kPy4oKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG9uUG9pbnRlckVudGVyKGV2ZW50OiBQb2ludGVyRXZlbnQpOiB2b2lkIHtcbiAgICBpZiAoZ2xvYmFsUG9pbnRlckV2ZW50cy5pZ25vcmVFbXVsYXRlZE1vdXNlRXZlbnRzICYmIGV2ZW50LnBvaW50ZXJUeXBlID09PSAnbW91c2UnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgb25Ib3ZlclN0YXJ0KGV2ZW50LCBldmVudC5wb2ludGVyVHlwZSk7XG4gIH1cblxuICBmdW5jdGlvbiBvblBvaW50ZXJMZWF2ZShldmVudDogUG9pbnRlckV2ZW50KTogdm9pZCB7XG4gICAgaWYgKCFkaXNhYmxlZCgpICYmIChldmVudC5jdXJyZW50VGFyZ2V0IGFzIEVsZW1lbnQpPy5jb250YWlucyhldmVudC50YXJnZXQgYXMgRWxlbWVudCkpIHtcbiAgICAgIG9uSG92ZXJFbmQoZXZlbnQucG9pbnRlclR5cGUpO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIG9uVG91Y2hTdGFydCgpOiB2b2lkIHtcbiAgICBpZ25vcmVFbXVsYXRlZE1vdXNlRXZlbnRzID0gdHJ1ZTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG9uTW91c2VFbnRlcihldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xuICAgIGlmICghaWdub3JlRW11bGF0ZWRNb3VzZUV2ZW50cyAmJiAhZ2xvYmFsUG9pbnRlckV2ZW50cy5pZ25vcmVFbXVsYXRlZE1vdXNlRXZlbnRzKSB7XG4gICAgICBvbkhvdmVyU3RhcnQoZXZlbnQsICdtb3VzZScpO1xuICAgIH1cblxuICAgIGlnbm9yZUVtdWxhdGVkTW91c2VFdmVudHMgPSBmYWxzZTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG9uTW91c2VMZWF2ZShldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xuICAgIGlmICghZGlzYWJsZWQoKSAmJiAoZXZlbnQuY3VycmVudFRhcmdldCBhcyBFbGVtZW50KT8uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIEVsZW1lbnQpKSB7XG4gICAgICBvbkhvdmVyRW5kKCdtb3VzZScpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7IGhvdmVyZWQgfTtcbn1cbiJdfQ==