/**
 * Copyright © 2024 Angular Primitives.
 * https://github.com/ng-primitives/ng-primitives
 *
 * This source code is licensed under the Apache 2.0 license found in the
 * LICENSE file in the root directory of this source tree.
 */
import { InteractivityChecker } from '@angular/cdk/a11y';
import { booleanAttribute, Directive, ElementRef, HostListener, inject, input, NgZone, } from '@angular/core';
import { NgpFocusTrapToken } from './focus-trap.token';
import * as i0 from "@angular/core";
/**
 * This implementation is based on the Radix UI FocusScope:
 * https://github.com/radix-ui/primitives/blob/main/packages/react/focus-scope/src/FocusScope.tsx#L306
 */
class FocusTrap {
    constructor() {
        /**
         * Whether the focus trap is active.
         */
        this.active = false;
    }
    /**
     * Activates the focus trap.
     */
    activate() {
        this.active = true;
    }
    /**
     * Deactivates the focus trap.
     */
    deactivate() {
        this.active = false;
    }
}
class FocusTrapStack {
    constructor() {
        /**
         * The stack of focus traps.
         */
        this.stack = [];
    }
    /**
     * Adds a focus trap to the stack.
     */
    add(focusTrap) {
        // deactivate the previous focus trap
        this.stack.forEach(t => t.deactivate());
        // add the new focus trap and activate it
        this.stack.push(focusTrap);
        focusTrap.activate();
    }
    /**
     * Removes a focus trap from the stack.
     */
    remove(focusTrap) {
        // remove the focus trap
        const index = this.stack.indexOf(focusTrap);
        if (index >= 0) {
            this.stack.splice(index, 1);
        }
        // activate the previous focus trap
        const previous = this.stack[this.stack.length - 1];
        if (previous) {
            previous.activate();
        }
    }
}
// create a global stack of focus traps
const focusTrapStack = new FocusTrapStack();
export class NgpFocusTrap {
    constructor() {
        /**
         * Create a new focus trap.
         */
        this.focusTrap = new FocusTrap();
        /**
         * Access the interactivity checker.
         */
        this.interactivityChecker = inject(InteractivityChecker);
        /**
         * Get the focus trap container element.
         */
        this.elementRef = inject(ElementRef);
        /**
         * Access NgZone to run the focus trap events outside of Angular's zone.
         */
        this.ngZone = inject(NgZone);
        /**
         * Store the mutation observer.
         */
        this.mutationObserver = null;
        /**
         * Store the last focused element.
         */
        this.lastFocusedElement = null;
        /**
         * Whether the focus trap is disabled.
         */
        this.disabled = input(false, {
            alias: 'ngpFocusTrapDisabled',
            transform: booleanAttribute,
        });
    }
    ngOnInit() {
        focusTrapStack.add(this.focusTrap);
        this.mutationObserver = new MutationObserver(this.handleMutations.bind(this));
        // setup event listeners
        this.ngZone.runOutsideAngular(() => {
            this.mutationObserver.observe(this.elementRef.nativeElement, {
                childList: true,
                subtree: true,
            });
            document.addEventListener('focusin', this.handleFocusIn.bind(this));
            document.addEventListener('focusout', this.handleFocusOut.bind(this));
        });
        const previouslyFocusedElement = document.activeElement;
        const hasFocusedCandidate = this.elementRef.nativeElement.contains(previouslyFocusedElement);
        if (!hasFocusedCandidate) {
            this.focusFirst();
            // if the focus didn't change, focus the container
            if (document.activeElement === previouslyFocusedElement) {
                this.focus(this.elementRef.nativeElement);
            }
        }
    }
    ngOnDestroy() {
        focusTrapStack.remove(this.focusTrap);
        this.mutationObserver?.disconnect();
    }
    handleFocusIn(event) {
        if (!this.focusTrap.active || this.disabled()) {
            return;
        }
        const target = event.target;
        if (this.elementRef.nativeElement.contains(target)) {
            this.lastFocusedElement = target;
        }
        else {
            this.focus(this.lastFocusedElement);
        }
    }
    /**
     * Handles the `focusout` event.
     */
    handleFocusOut(event) {
        if (!this.focusTrap.active || this.disabled() || event.relatedTarget === null) {
            return;
        }
        const relatedTarget = event.relatedTarget;
        if (!this.elementRef.nativeElement.contains(relatedTarget)) {
            this.focus(this.lastFocusedElement);
        }
    }
    /**
     * If the focused element gets removed from the DOM, browsers move focus back to the document.body.
     * We move focus to the container to keep focus trapped correctly.
     */
    handleMutations(mutations) {
        const focusedElement = document.activeElement;
        if (focusedElement !== document.body) {
            return;
        }
        for (const mutation of mutations) {
            if (mutation.removedNodes.length > 0) {
                this.focus(this.elementRef.nativeElement);
            }
        }
    }
    /**
     * Handles the `keydown` event.
     */
    handleKeyDown(event) {
        if (!this.focusTrap.active || this.disabled()) {
            return;
        }
        const isTabKey = event.key === 'Tab' && !event.altKey && !event.ctrlKey && !event.metaKey;
        const focusedElement = document.activeElement;
        if (isTabKey && focusedElement) {
            const container = event.currentTarget;
            const [first, last] = this.getTabbableEdges(container);
            const hasTabbableElementsInside = first && last;
            // we can only wrap focus if we have tabbable edges
            if (!hasTabbableElementsInside) {
                if (focusedElement === container) {
                    event.preventDefault();
                }
            }
            else {
                if (!event.shiftKey && focusedElement === last) {
                    event.preventDefault();
                    this.focus(first);
                }
                else if (event.shiftKey && focusedElement === first) {
                    event.preventDefault();
                    this.focus(last);
                }
            }
        }
    }
    /**
     * Returns the first and last tabbable elements inside a container.
     */
    getTabbableEdges(container) {
        const candidates = this.getTabbableCandidates(container);
        const first = this.findVisible(candidates);
        const last = this.findVisible(candidates.reverse());
        return [first, last];
    }
    /**
     * Returns a list of potential focusable elements inside a container.
     */
    getTabbableCandidates(container) {
        const nodes = [];
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_ELEMENT, {
            acceptNode: (node) => this.interactivityChecker.isFocusable(node)
                ? NodeFilter.FILTER_ACCEPT
                : NodeFilter.FILTER_SKIP,
        });
        while (walker.nextNode()) {
            nodes.push(walker.currentNode);
        }
        return nodes;
    }
    /**
     * Returns the first visible element in a list..
     */
    findVisible(elements) {
        return elements.find(element => this.interactivityChecker.isVisible(element)) ?? null;
    }
    focus(element) {
        element?.focus({ preventScroll: true });
    }
    focusFirst() {
        const previouslyFocusedElement = document.activeElement;
        for (const candidate of this.getTabbableCandidates(this.elementRef.nativeElement)) {
            this.focus(candidate);
            if (document.activeElement !== previouslyFocusedElement) {
                return;
            }
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: NgpFocusTrap, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "17.1.0", version: "18.2.13", type: NgpFocusTrap, isStandalone: true, selector: "[ngpFocusTrap]", inputs: { disabled: { classPropertyName: "disabled", publicName: "ngpFocusTrapDisabled", isSignal: true, isRequired: false, transformFunction: null } }, host: { listeners: { "keydown": "handleKeyDown($event)" }, properties: { "attr.tabindex": "-1", "attr.data-focus-trap": "!disabled() ? \"\" : null" } }, providers: [{ provide: NgpFocusTrapToken, useExisting: NgpFocusTrap }], exportAs: ["ngpFocusTrap"], ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: NgpFocusTrap, decorators: [{
            type: Directive,
            args: [{
                    standalone: true,
                    selector: '[ngpFocusTrap]',
                    exportAs: 'ngpFocusTrap',
                    providers: [{ provide: NgpFocusTrapToken, useExisting: NgpFocusTrap }],
                    host: {
                        '[attr.tabindex]': '-1',
                        '[attr.data-focus-trap]': '!disabled() ? "" : null',
                    },
                }]
        }], propDecorators: { handleKeyDown: [{
                type: HostListener,
                args: ['keydown', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9jdXMtdHJhcC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9uZy1wcmltaXRpdmVzL2ZvY3VzLXRyYXAvc3JjL2ZvY3VzLXRyYXAvZm9jdXMtdHJhcC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBQ0gsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDekQsT0FBTyxFQUNMLGdCQUFnQixFQUNoQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixNQUFNLEVBQ04sS0FBSyxFQUNMLE1BQU0sR0FHUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQzs7QUFFdkQ7OztHQUdHO0FBRUgsTUFBTSxTQUFTO0lBQWY7UUFDRTs7V0FFRztRQUNILFdBQU0sR0FBWSxLQUFLLENBQUM7SUFlMUIsQ0FBQztJQWJDOztPQUVHO0lBQ0gsUUFBUTtRQUNOLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFFRDs7T0FFRztJQUNILFVBQVU7UUFDUixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztJQUN0QixDQUFDO0NBQ0Y7QUFFRCxNQUFNLGNBQWM7SUFBcEI7UUFDRTs7V0FFRztRQUNjLFVBQUssR0FBZ0IsRUFBRSxDQUFDO0lBZ0MzQyxDQUFDO0lBOUJDOztPQUVHO0lBQ0gsR0FBRyxDQUFDLFNBQW9CO1FBQ3RCLHFDQUFxQztRQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBRXhDLHlDQUF5QztRQUN6QyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMzQixTQUFTLENBQUMs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QUFFO3dCQUNKLGlCQUFpQixFQUFFLElBQUk7d0JBQ3ZCLHdCQUF3QixFQUFFLHlCQUF5QjtxQkFDcEQ7aUJBQ0Y7OEJBNEhXLGFBQWE7c0JBRHRCLFlBQVk7dUJBQUMsU0FBUyxFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgwqkgMjAyNCBBbmd1bGFyIFByaW1pdGl2ZXMuXG4gKiBodHRwczovL2dpdGh1Yi5jb20vbmctcHJpbWl0aXZlcy9uZy1wcmltaXRpdmVzXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIDIuMCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5pbXBvcnQgeyBJbnRlcmFjdGl2aXR5Q2hlY2tlciB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9hMTF5JztcbmltcG9ydCB7XG4gIGJvb2xlYW5BdHRyaWJ1dGUsXG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgSG9zdExpc3RlbmVyLFxuICBpbmplY3QsXG4gIGlucHV0LFxuICBOZ1pvbmUsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5ncEZvY3VzVHJhcFRva2VuIH0gZnJvbSAnLi9mb2N1cy10cmFwLnRva2VuJztcblxuLyoqXG4gKiBUaGlzIGltcGxlbWVudGF0aW9uIGlzIGJhc2VkIG9uIHRoZSBSYWRpeCBVSSBGb2N1c1Njb3BlOlxuICogaHR0cHM6Ly9naXRodWIuY29tL3JhZGl4LXVpL3ByaW1pdGl2ZXMvYmxvYi9tYWluL3BhY2thZ2VzL3JlYWN0L2ZvY3VzLXNjb3BlL3NyYy9Gb2N1c1Njb3BlLnRzeCNMMzA2XG4gKi9cblxuY2xhc3MgRm9jdXNUcmFwIHtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIGZvY3VzIHRyYXAgaXMgYWN0aXZlLlxuICAgKi9cbiAgYWN0aXZlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEFjdGl2YXRlcyB0aGUgZm9jdXMgdHJhcC5cbiAgICovXG4gIGFjdGl2YXRlKCk6IHZvaWQge1xuICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWFjdGl2YXRlcyB0aGUgZm9jdXMgdHJhcC5cbiAgICovXG4gIGRlYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgdGhpcy5hY3RpdmUgPSBmYWxzZTtcbiAgfVxufVxuXG5jbGFzcyBGb2N1c1RyYXBTdGFjayB7XG4gIC8qKlxuICAgKiBUaGUgc3RhY2sgb2YgZm9jdXMgdHJhcHMuXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHN0YWNrOiBGb2N1c1RyYXBbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiBBZGRzIGEgZm9jdXMgdHJhcCB0byB0aGUgc3RhY2suXG4gICAqL1xuICBhZGQoZm9jdXNUcmFwOiBGb2N1c1RyYXApOiB2b2lkIHtcbiAgICAvLyBkZWFjdGl2YXRlIHRoZSBwcmV2aW91cyBmb2N1cyB0cmFwXG4gICAgdGhpcy5zdGFjay5mb3JFYWNoKHQgPT4gdC5kZWFjdGl2YXRlKCkpO1xuXG4gICAgLy8gYWRkIHRoZSBuZXcgZm9jdXMgdHJhcCBhbmQgYWN0aXZhdGUgaXRcbiAgICB0aGlzLnN0YWNrLnB1c2goZm9jdXNUcmFwKTtcbiAgICBmb2N1c1RyYXAuYWN0aXZhdGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGEgZm9jdXMgdHJhcCBmcm9tIHRoZSBzdGFjay5cbiAgICovXG4gIHJlbW92ZShmb2N1c1RyYXA6IEZvY3VzVHJhcCk6IHZvaWQge1xuICAgIC8vIHJlbW92ZSB0aGUgZm9jdXMgdHJhcFxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zdGFjay5pbmRleE9mKGZvY3VzVHJhcCk7XG5cbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgdGhpcy5zdGFjay5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cblxuICAgIC8vIGFjdGl2YXRlIHRoZSBwcmV2aW91cyBmb2N1cyB0cmFwXG4gICAgY29uc3QgcHJldmlvdXMgPSB0aGlzLnN0YWNrW3RoaXMuc3RhY2subGVuZ3RoIC0gMV07XG5cbiAgICBpZiAocHJldmlvdXMpIHtcbiAgICAgIHByZXZpb3VzLmFjdGl2YXRlKCk7XG4gICAgfVxuICB9XG59XG5cbi8vIGNyZWF0ZSBhIGdsb2JhbCBzdGFjayBvZiBmb2N1cyB0cmFwc1xuY29uc3QgZm9jdXNUcmFwU3RhY2sgPSBuZXcgRm9jdXNUcmFwU3RhY2soKTtcblxuQERpcmVjdGl2ZSh7XG4gIHN0YW5kYWxvbmU6IHRydWUsXG4gIHNlbGVjdG9yOiAnW25ncEZvY3VzVHJhcF0nLFxuICBleHBvcnRBczogJ25ncEZvY3VzVHJhcCcsXG4gIHByb3ZpZGVyczogW3sgcHJvdmlkZTogTmdwRm9jdXNUcmFwVG9rZW4sIHVzZUV4aXN0aW5nOiBOZ3BGb2N1c1RyYXAgfV0sXG4gIGhvc3Q6IHtcbiAgICAnW2F0dHIudGFiaW5kZXhdJzogJy0xJyxcbiAgICAnW2F0dHIuZGF0YS1mb2N1cy10cmFwXSc6ICchZGlzYWJsZWQoKSA/IFwiXCIgOiBudWxsJyxcbiAgfSxcbn0pXG5leHBvcnQgY2xhc3MgTmdwRm9jdXNUcmFwIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IGZvY3VzIHRyYXAuXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGZvY3VzVHJhcCA9IG5ldyBGb2N1c1RyYXAoKTtcblxuICAvKipcbiAgICogQWNjZXNzIHRoZSBpbnRlcmFjdGl2aXR5IGNoZWNrZXIuXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGludGVyYWN0aXZpdHlDaGVja2VyID0gaW5qZWN0KEludGVyYWN0aXZpdHlDaGVja2VyKTtcblxuICAvKipcbiAgICogR2V0IHRoZSBmb2N1cyB0cmFwIGNvbnRhaW5lciBlbGVtZW50LlxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBlbGVtZW50UmVmID0gaW5qZWN0PEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+PihFbGVtZW50UmVmKTtcblxuICAvKipcbiAgICogQWNjZXNzIE5nWm9uZSB0byBydW4gdGhlIGZvY3VzIHRyYXAgZXZlbnRzIG91dHNpZGUgb2YgQW5ndWxhcidzIHpvbmUuXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IG5nWm9uZSA9IGluamVjdChOZ1pvbmUpO1xuXG4gIC8qKlxuICAgKiBTdG9yZSB0aGUgbXV0YXRpb24gb2JzZXJ2ZXIuXG4gICAqL1xuICBwcml2YXRlIG11dGF0aW9uT2JzZXJ2ZXI6IE11dGF0aW9uT2JzZXJ2ZXIgfCBudWxsID0gbnVsbDtcblxuICAvKipcbiAgICogU3RvcmUgdGhlIGxhc3QgZm9jdXNlZCBlbGVtZW50LlxuICAgKi9cbiAgcHJpdmF0ZSBsYXN0Rm9jdXNlZEVsZW1lbnQ6IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGw7XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIGZvY3VzIHRyYXAgaXMgZGlzYWJsZWQuXG4gICAqL1xuICByZWFkb25seSBkaXNhYmxlZCA9IGlucHV0KGZhbHNlLCB7XG4gICAgYWxpYXM6ICduZ3BGb2N1c1RyYXBEaXNhYmxlZCcsXG4gICAgdHJhbnNmb3JtOiBib29sZWFuQXR0cmlidXRlLFxuICB9KTtcblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICBmb2N1c1RyYXBTdGFjay5hZGQodGhpcy5mb2N1c1RyYXApO1xuXG4gICAgdGhpcy5tdXRhdGlvbk9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIodGhpcy5oYW5kbGVNdXRhdGlvbnMuYmluZCh0aGlzKSk7XG5cbiAgICAvLyBzZXR1cCBldmVudCBsaXN0ZW5lcnNcbiAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICB0aGlzLm11dGF0aW9uT2JzZXJ2ZXIhLm9ic2VydmUodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsIHtcbiAgICAgICAgY2hpbGRMaXN0OiB0cnVlLFxuICAgICAgICBzdWJ0cmVlOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdmb2N1c2luJywgdGhpcy5oYW5kbGVGb2N1c0luLmJpbmQodGhpcykpO1xuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXNvdXQnLCB0aGlzLmhhbmRsZUZvY3VzT3V0LmJpbmQodGhpcykpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcHJldmlvdXNseUZvY3VzZWRFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudCB8IG51bGw7XG4gICAgY29uc3QgaGFzRm9jdXNlZENhbmRpZGF0ZSA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKHByZXZpb3VzbHlGb2N1c2VkRWxlbWVudCk7XG5cbiAgICBpZiAoIWhhc0ZvY3VzZWRDYW5kaWRhdGUpIHtcbiAgICAgIHRoaXMuZm9jdXNGaXJzdCgpO1xuXG4gICAgICAvLyBpZiB0aGUgZm9jdXMgZGlkbid0IGNoYW5nZSwgZm9jdXMgdGhlIGNvbnRhaW5lclxuICAgICAgaWYgKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IHByZXZpb3VzbHlGb2N1c2VkRWxlbWVudCkge1xuICAgICAgICB0aGlzLmZvY3VzKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBmb2N1c1RyYXBTdGFjay5yZW1vdmUodGhpcy5mb2N1c1RyYXApO1xuICAgIHRoaXMubXV0YXRpb25PYnNlcnZlcj8uZGlzY29ubmVjdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVGb2N1c0luKGV2ZW50OiBGb2N1c0V2ZW50KTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmZvY3VzVHJhcC5hY3RpdmUgfHwgdGhpcy5kaXNhYmxlZCgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IGFzIEhUTUxFbGVtZW50IHwgbnVsbDtcblxuICAgIGlmICh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jb250YWlucyh0YXJnZXQpKSB7XG4gICAgICB0aGlzLmxhc3RGb2N1c2VkRWxlbWVudCA9IHRhcmdldDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5mb2N1cyh0aGlzLmxhc3RGb2N1c2VkRWxlbWVudCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZXMgdGhlIGBmb2N1c291dGAgZXZlbnQuXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZUZvY3VzT3V0KGV2ZW50OiBGb2N1c0V2ZW50KSB7XG4gICAgaWYgKCF0aGlzLmZvY3VzVHJhcC5hY3RpdmUgfHwgdGhpcy5kaXNhYmxlZCgpIHx8IGV2ZW50LnJlbGF0ZWRUYXJnZXQgPT09IG51bGwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCByZWxhdGVkVGFyZ2V0ID0gZXZlbnQucmVsYXRlZFRhcmdldCBhcyBIVE1MRWxlbWVudDtcblxuICAgIGlmICghdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY29udGFpbnMocmVsYXRlZFRhcmdldCkpIHtcbiAgICAgIHRoaXMuZm9jdXModGhpcy5sYXN0Rm9jdXNlZEVsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJZiB0aGUgZm9jdXNlZCBlbGVtZW50IGdldHMgcmVtb3ZlZCBmcm9tIHRoZSBET00sIGJyb3dzZXJzIG1vdmUgZm9jdXMgYmFjayB0byB0aGUgZG9jdW1lbnQuYm9keS5cbiAgICogV2UgbW92ZSBmb2N1cyB0byB0aGUgY29udGFpbmVyIHRvIGtlZXAgZm9jdXMgdHJhcHBlZCBjb3JyZWN0bHkuXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZU11dGF0aW9ucyhtdXRhdGlvbnM6IE11dGF0aW9uUmVjb3JkW10pOiB2b2lkIHtcbiAgICBjb25zdCBmb2N1c2VkRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQgfCBudWxsO1xuXG4gICAgaWYgKGZvY3VzZWRFbGVtZW50ICE9PSBkb2N1bWVudC5ib2R5KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBtdXRhdGlvbiBvZiBtdXRhdGlvbnMpIHtcbiAgICAgIGlmIChtdXRhdGlvbi5yZW1vdmVkTm9kZXMubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLmZvY3VzKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlcyB0aGUgYGtleWRvd25gIGV2ZW50LlxuICAgKi9cbiAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bicsIFsnJGV2ZW50J10pXG4gIHByb3RlY3RlZCBoYW5kbGVLZXlEb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmZvY3VzVHJhcC5hY3RpdmUgfHwgdGhpcy5kaXNhYmxlZCgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaXNUYWJLZXkgPSBldmVudC5rZXkgPT09ICdUYWInICYmICFldmVudC5hbHRLZXkgJiYgIWV2ZW50LmN0cmxLZXkgJiYgIWV2ZW50Lm1ldGFLZXk7XG4gICAgY29uc3QgZm9jdXNlZEVsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGFzIEhUTUxFbGVtZW50IHwgbnVsbDtcblxuICAgIGlmIChpc1RhYktleSAmJiBmb2N1c2VkRWxlbWVudCkge1xuICAgICAgY29uc3QgY29udGFpbmVyID0gZXZlbnQuY3VycmVudFRhcmdldCBhcyBIVE1MRWxlbWVudDtcbiAgICAgIGNvbnN0IFtmaXJzdCwgbGFzdF0gPSB0aGlzLmdldFRhYmJhYmxlRWRnZXMoY29udGFpbmVyKTtcbiAgICAgIGNvbnN0IGhhc1RhYmJhYmxlRWxlbWVudHNJbnNpZGUgPSBmaXJzdCAmJiBsYXN0O1xuXG4gICAgICAvLyB3ZSBjYW4gb25seSB3cmFwIGZvY3VzIGlmIHdlIGhhdmUgdGFiYmFibGUgZWRnZXNcbiAgICAgIGlmICghaGFzVGFiYmFibGVFbGVtZW50c0luc2lkZSkge1xuICAgICAgICBpZiAoZm9jdXNlZEVsZW1lbnQgPT09IGNvbnRhaW5lcikge1xuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghZXZlbnQuc2hpZnRLZXkgJiYgZm9jdXNlZEVsZW1lbnQgPT09IGxhc3QpIHtcbiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIHRoaXMuZm9jdXMoZmlyc3QpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LnNoaWZ0S2V5ICYmIGZvY3VzZWRFbGVtZW50ID09PSBmaXJzdCkge1xuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgdGhpcy5mb2N1cyhsYXN0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBmaXJzdCBhbmQgbGFzdCB0YWJiYWJsZSBlbGVtZW50cyBpbnNpZGUgYSBjb250YWluZXIuXG4gICAqL1xuICBwcml2YXRlIGdldFRhYmJhYmxlRWRnZXMoY29udGFpbmVyOiBIVE1MRWxlbWVudCkge1xuICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSB0aGlzLmdldFRhYmJhYmxlQ2FuZGlkYXRlcyhjb250YWluZXIpO1xuICAgIGNvbnN0IGZpcnN0ID0gdGhpcy5maW5kVmlzaWJsZShjYW5kaWRhdGVzKTtcbiAgICBjb25zdCBsYXN0ID0gdGhpcy5maW5kVmlzaWJsZShjYW5kaWRhdGVzLnJldmVyc2UoKSk7XG4gICAgcmV0dXJuIFtmaXJzdCwgbGFzdF0gYXMgY29uc3Q7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIGxpc3Qgb2YgcG90ZW50aWFsIGZvY3VzYWJsZSBlbGVtZW50cyBpbnNpZGUgYSBjb250YWluZXIuXG4gICAqL1xuICBwcml2YXRlIGdldFRhYmJhYmxlQ2FuZGlkYXRlcyhjb250YWluZXI6IEhUTUxFbGVtZW50KSB7XG4gICAgY29uc3Qgbm9kZXM6IEhUTUxFbGVtZW50W10gPSBbXTtcbiAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGNvbnRhaW5lciwgTm9kZUZpbHRlci5TSE9XX0VMRU1FTlQsIHtcbiAgICAgIGFjY2VwdE5vZGU6IChub2RlOiBIVE1MRWxlbWVudCkgPT5cbiAgICAgICAgdGhpcy5pbnRlcmFjdGl2aXR5Q2hlY2tlci5pc0ZvY3VzYWJsZShub2RlKVxuICAgICAgICAgID8gTm9kZUZpbHRlci5GSUxURVJfQUNDRVBUXG4gICAgICAgICAgOiBOb2RlRmlsdGVyLkZJTFRFUl9TS0lQLFxuICAgIH0pO1xuICAgIHdoaWxlICh3YWxrZXIubmV4dE5vZGUoKSkge1xuICAgICAgbm9kZXMucHVzaCh3YWxrZXIuY3VycmVudE5vZGUgYXMgSFRNTEVsZW1lbnQpO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZXM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZmlyc3QgdmlzaWJsZSBlbGVtZW50IGluIGEgbGlzdC4uXG4gICAqL1xuICBwcml2YXRlIGZpbmRWaXNpYmxlKGVsZW1lbnRzOiBIVE1MRWxlbWVudFtdKSB7XG4gICAgcmV0dXJuIGVsZW1lbnRzLmZpbmQoZWxlbWVudCA9PiB0aGlzLmludGVyYWN0aXZpdHlDaGVja2VyLmlzVmlzaWJsZShlbGVtZW50KSkgPz8gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgZm9jdXMoZWxlbWVudD86IEhUTUxFbGVtZW50IHwgbnVsbCkge1xuICAgIGVsZW1lbnQ/LmZvY3VzKHsgcHJldmVudFNjcm9sbDogdHJ1ZSB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZm9jdXNGaXJzdCgpOiB2b2lkIHtcbiAgICBjb25zdCBwcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50O1xuXG4gICAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgdGhpcy5nZXRUYWJiYWJsZUNhbmRpZGF0ZXModGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpKSB7XG4gICAgICB0aGlzLmZvY3VzKGNhbmRpZGF0ZSk7XG5cbiAgICAgIGlmIChkb2N1bWVudC5hY3RpdmVFbGVtZW50ICE9PSBwcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19