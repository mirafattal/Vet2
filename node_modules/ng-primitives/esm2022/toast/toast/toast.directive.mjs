import { DomPortalOutlet, TemplatePortal } from '@angular/cdk/portal';
import { DOCUMENT } from '@angular/common';
import { booleanAttribute, Directive, inject, Injector, input, numberAttribute, TemplateRef, ViewContainerRef, } from '@angular/core';
import { injectToastConfig } from '../config/toast.config';
import { NgpToastRef } from './toast-ref';
import { NgpToastToken } from './toast.token';
import * as i0 from "@angular/core";
export class NgpToast {
    constructor() {
        this.config = injectToastConfig();
        /** Access the ng-template */
        this.template = inject(TemplateRef);
        /** Access the view container */
        this.viewContainer = inject(ViewContainerRef);
        /** Access the injector */
        this.injector = inject(Injector);
        /** Access the document */
        this.document = inject(DOCUMENT);
        this.duration = input(this.config.duration, {
            alias: 'ngpToastDuration',
            transform: numberAttribute,
        });
        this.gravity = input(this.config.gravity, {
            alias: 'ngpToastGravity',
        });
        this.position = input(this.config.position, {
            alias: 'ngpToastPosition',
        });
        this.stopOnHover = input(this.config.stopOnHover, {
            alias: 'ngpToastStopOnHover',
            transform: booleanAttribute,
        });
        this.ariaLive = input(this.config.ariaLive, {
            alias: 'ngpToastAriaLive',
        });
        /** Store the list of toasts */
        this.toasts = [];
    }
    /** Show the toast. */
    show() {
        this.createToast();
        this.reposition();
    }
    /** Build the toast */
    createToast() {
        const portal = new TemplatePortal(this.template, this.viewContainer, {
            dismiss: () => toastRef.dismiss(),
        }, this.injector);
        const domOutlet = new DomPortalOutlet(this.document.body, undefined, undefined, Injector.create({
            parent: this.injector,
            providers: [],
        }));
        const viewRef = domOutlet.attach(portal);
        viewRef.detectChanges();
        const toastElement = viewRef.rootNodes[0];
        const toastRef = new NgpToastRef(toastElement, this.duration(), this.position(), this.gravity(), this.stopOnHover(), this.ariaLive(), () => {
            this.toasts = this.toasts.filter(t => t !== toastRef);
            this.reposition();
        });
        this.toasts = [...this.toasts, toastRef];
    }
    /** Position the toast on the DOM */
    reposition() {
        const topStartOffsetSize = {
            top: this.config.gap,
            bottom: this.config.gap,
        };
        const topEndOffsetSize = {
            top: this.config.gap,
            bottom: this.config.gap,
        };
        let position;
        // update the position of the toasts
        for (const toast of this.toasts) {
            // Getting the applied gravity
            position = toast.gravity;
            const height = toast.height;
            if (toast.position === 'start') {
                toast.setInset(position, `${topStartOffsetSize[position]}px`);
                topStartOffsetSize[position] += height + this.config.gap;
            }
            else {
                toast.setInset(position, `${topEndOffsetSize[position]}px`);
                topEndOffsetSize[position] += height + this.config.gap;
            }
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: NgpToast, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "17.1.0", version: "18.2.13", type: NgpToast, isStandalone: true, selector: "[ngpToast]", inputs: { duration: { classPropertyName: "duration", publicName: "ngpToastDuration", isSignal: true, isRequired: false, transformFunction: null }, gravity: { classPropertyName: "gravity", publicName: "ngpToastGravity", isSignal: true, isRequired: false, transformFunction: null }, position: { classPropertyName: "position", publicName: "ngpToastPosition", isSignal: true, isRequired: false, transformFunction: null }, stopOnHover: { classPropertyName: "stopOnHover", publicName: "ngpToastStopOnHover", isSignal: true, isRequired: false, transformFunction: null }, ariaLive: { classPropertyName: "ariaLive", publicName: "ngpToastAriaLive", isSignal: true, isRequired: false, transformFunction: null } }, providers: [{ provide: NgpToastToken, useExisting: NgpToast }], exportAs: ["ngpToast"], ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: NgpToast, decorators: [{
            type: Directive,
            args: [{
                    standalone: true,
                    selector: '[ngpToast]',
                    exportAs: 'ngpToast',
                    providers: [{ provide: NgpToastToken, useExisting: NgpToast }],
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9hc3QuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvbmctcHJpbWl0aXZlcy90b2FzdC9zcmMvdG9hc3QvdG9hc3QuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQVFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsU0FBUyxFQUNULE1BQU0sRUFDTixRQUFRLEVBQ1IsS0FBSyxFQUNMLGVBQWUsRUFDZixXQUFXLEVBQ1gsZ0JBQWdCLEdBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBcUMsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUM7O0FBWTlDLE1BQU0sT0FBTyxRQUFRO0lBTnJCO1FBT21CLFdBQU0sR0FBRyxpQkFBaUIsRUFBRSxDQUFDO1FBRTlDLDZCQUE2QjtRQUNaLGFBQVEsR0FBRyxNQUFNLENBQStCLFdBQVcsQ0FBQyxDQUFDO1FBRTlFLGdDQUFnQztRQUNmLGtCQUFhLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFMUQsMEJBQTBCO1FBQ1QsYUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUU3QywwQkFBMEI7UUFDVCxhQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXBDLGFBQVEsR0FBRyxLQUFLLENBQXNCLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFO1lBQ25FLEtBQUssRUFBRSxrQkFBa0I7WUFDekIsU0FBUyxFQUFFLGVBQWU7U0FDM0IsQ0FBQyxD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RUFBRSxDQUFDO1lBQ2hDLDhCQUE4QjtZQUM5QixRQUFRLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztZQUV6QixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBRTVCLElBQUksS0FBSyxDQUFDLFFBQVEsS0FBSyxPQUFPLEVBQUUsQ0FBQztnQkFDL0IsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzlELGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQztZQUMzRCxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzVELGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQztZQUN6RCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7K0dBckhVLFFBQVE7bUdBQVIsUUFBUSx3dkJBRlIsQ0FBQyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxDQUFDOzs0RkFFbkQsUUFBUTtrQkFOcEIsU0FBUzttQkFBQztvQkFDVCxVQUFVLEVBQUUsSUFBSTtvQkFDaEIsUUFBUSxFQUFFLFlBQVk7b0JBQ3RCLFFBQVEsRUFBRSxVQUFVO29CQUNwQixTQUFTLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsV0FBVyxVQUFVLEVBQUUsQ0FBQztpQkFDL0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCDCqSAyMDI0IEFuZ3VsYXIgUHJpbWl0aXZlcy5cbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9uZy1wcmltaXRpdmVzL25nLXByaW1pdGl2ZXNcbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgMi4wIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cbmltcG9ydCB7IEJvb2xlYW5JbnB1dCwgTnVtYmVySW5wdXQgfSBmcm9tICdAYW5ndWxhci9jZGsvY29lcmNpb24nO1xuaW1wb3J0IHsgRG9tUG9ydGFsT3V0bGV0LCBUZW1wbGF0ZVBvcnRhbCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wb3J0YWwnO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgYm9vbGVhbkF0dHJpYnV0ZSxcbiAgRGlyZWN0aXZlLFxuICBpbmplY3QsXG4gIEluamVjdG9yLFxuICBpbnB1dCxcbiAgbnVtYmVyQXR0cmlidXRlLFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NvbnRhaW5lclJlZixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBpbmplY3RUb2FzdENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy90b2FzdC5jb25maWcnO1xuaW1wb3J0IHsgTmdwVG9hc3RHcmF2aXR5LCBOZ3BUb2FzdFBvc2l0aW9uLCBOZ3BUb2FzdFJlZiB9IGZyb20gJy4vdG9hc3QtcmVmJztcbmltcG9ydCB7IE5ncFRvYXN0VG9rZW4gfSBmcm9tICcuL3RvYXN0LnRva2VuJztcblxuZXhwb3J0IGludGVyZmFjZSBOZ3BUb2FzdENvbnRleHQge1xuICBkaXNtaXNzOiAoKSA9PiB2b2lkO1xufVxuXG5ARGlyZWN0aXZlKHtcbiAgc3RhbmRhbG9uZTogdHJ1ZSxcbiAgc2VsZWN0b3I6ICdbbmdwVG9hc3RdJyxcbiAgZXhwb3J0QXM6ICduZ3BUb2FzdCcsXG4gIHByb3ZpZGVyczogW3sgcHJvdmlkZTogTmdwVG9hc3RUb2tlbiwgdXNlRXhpc3Rpbmc6IE5ncFRvYXN0IH1dLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3BUb2FzdCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnID0gaW5qZWN0VG9hc3RDb25maWcoKTtcblxuICAvKiogQWNjZXNzIHRoZSBuZy10ZW1wbGF0ZSAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHRlbXBsYXRlID0gaW5qZWN0PFRlbXBsYXRlUmVmPE5ncFRvYXN0Q29udGV4dD4+KFRlbXBsYXRlUmVmKTtcblxuICAvKiogQWNjZXNzIHRoZSB2aWV3IGNvbnRhaW5lciAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHZpZXdDb250YWluZXIgPSBpbmplY3QoVmlld0NvbnRhaW5lclJlZik7XG5cbiAgLyoqIEFjY2VzcyB0aGUgaW5qZWN0b3IgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBpbmplY3RvciA9IGluamVjdChJbmplY3Rvcik7XG5cbiAgLyoqIEFjY2VzcyB0aGUgZG9jdW1lbnQgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBkb2N1bWVudCA9IGluamVjdChET0NVTUVOVCk7XG5cbiAgcmVhZG9ubHkgZHVyYXRpb24gPSBpbnB1dDxudW1iZXIsIE51bWJlcklucHV0Pih0aGlzLmNvbmZpZy5kdXJhdGlvbiwge1xuICAgIGFsaWFzOiAnbmdwVG9hc3REdXJhdGlvbicsXG4gICAgdHJhbnNmb3JtOiBudW1iZXJBdHRyaWJ1dGUsXG4gIH0pO1xuXG4gIHJlYWRvbmx5IGdyYXZpdHkgPSBpbnB1dDxOZ3BUb2FzdEdyYXZpdHk+KHRoaXMuY29uZmlnLmdyYXZpdHksIHtcbiAgICBhbGlhczogJ25ncFRvYXN0R3Jhdml0eScsXG4gIH0pO1xuXG4gIHJlYWRvbmx5IHBvc2l0aW9uID0gaW5wdXQ8TmdwVG9hc3RQb3NpdGlvbj4odGhpcy5jb25maWcucG9zaXRpb24sIHtcbiAgICBhbGlhczogJ25ncFRvYXN0UG9zaXRpb24nLFxuICB9KTtcblxuICByZWFkb25seSBzdG9wT25Ib3ZlciA9IGlucHV0PGJvb2xlYW4sIEJvb2xlYW5JbnB1dD4odGhpcy5jb25maWcuc3RvcE9uSG92ZXIsIHtcbiAgICBhbGlhczogJ25ncFRvYXN0U3RvcE9uSG92ZXInLFxuICAgIHRyYW5zZm9ybTogYm9vbGVhbkF0dHJpYnV0ZSxcbiAgfSk7XG5cbiAgcmVhZG9ubHkgYXJpYUxpdmUgPSBpbnB1dCh0aGlzLmNvbmZpZy5hcmlhTGl2ZSwge1xuICAgIGFsaWFzOiAnbmdwVG9hc3RBcmlhTGl2ZScsXG4gIH0pO1xuXG4gIC8qKiBTdG9yZSB0aGUgbGlzdCBvZiB0b2FzdHMgKi9cbiAgcHJpdmF0ZSB0b2FzdHM6IE5ncFRvYXN0UmVmW10gPSBbXTtcblxuICAvKiogU2hvdyB0aGUgdG9hc3QuICovXG4gIHNob3coKTogdm9pZCB7XG4gICAgdGhpcy5jcmVhdGVUb2FzdCgpO1xuICAgIHRoaXMucmVwb3NpdGlvbigpO1xuICB9XG5cbiAgLyoqIEJ1aWxkIHRoZSB0b2FzdCAqL1xuICBwcml2YXRlIGNyZWF0ZVRvYXN0KCk6IHZvaWQge1xuICAgIGNvbnN0IHBvcnRhbCA9IG5ldyBUZW1wbGF0ZVBvcnRhbDxOZ3BUb2FzdENvbnRleHQ+KFxuICAgICAgdGhpcy50ZW1wbGF0ZSxcbiAgICAgIHRoaXMudmlld0NvbnRhaW5lcixcbiAgICAgIHtcbiAgICAgICAgZGlzbWlzczogKCkgPT4gdG9hc3RSZWYuZGlzbWlzcygpLFxuICAgICAgfSxcbiAgICAgIHRoaXMuaW5qZWN0b3IsXG4gICAgKTtcblxuICAgIGNvbnN0IGRvbU91dGxldCA9IG5ldyBEb21Qb3J0YWxPdXRsZXQoXG4gICAgICB0aGlzLmRvY3VtZW50LmJvZHksXG4gICAgICB1bmRlZmluZWQsXG4gICAgICB1bmRlZmluZWQsXG4gICAgICBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgICBwYXJlbnQ6IHRoaXMuaW5qZWN0b3IsXG4gICAgICAgIHByb3ZpZGVyczogW10sXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgY29uc3Qgdmlld1JlZiA9IGRvbU91dGxldC5hdHRhY2gocG9ydGFsKTtcbiAgICB2aWV3UmVmLmRldGVjdENoYW5nZXMoKTtcblxuICAgIGNvbnN0IHRvYXN0RWxlbWVudCA9IHZpZXdSZWYucm9vdE5vZGVzWzBdO1xuXG4gICAgY29uc3QgdG9hc3RSZWYgPSBuZXcgTmdwVG9hc3RSZWYoXG4gICAgICB0b2FzdEVsZW1lbnQsXG4gICAgICB0aGlzLmR1cmF0aW9uKCksXG4gICAgICB0aGlzLnBvc2l0aW9uKCksXG4gICAgICB0aGlzLmdyYXZpdHkoKSxcbiAgICAgIHRoaXMuc3RvcE9uSG92ZXIoKSxcbiAgICAgIHRoaXMuYXJpYUxpdmUoKSxcbiAgICAgICgpID0+IHtcbiAgICAgICAgdGhpcy50b2FzdHMgPSB0aGlzLnRvYXN0cy5maWx0ZXIodCA9PiB0ICE9PSB0b2FzdFJlZik7XG4gICAgICAgIHRoaXMucmVwb3NpdGlvbigpO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgdGhpcy50b2FzdHMgPSBbLi4udGhpcy50b2FzdHMsIHRvYXN0UmVmXTtcbiAgfVxuXG4gIC8qKiBQb3NpdGlvbiB0aGUgdG9hc3Qgb24gdGhlIERPTSAqL1xuICBwcml2YXRlIHJlcG9zaXRpb24oKTogdm9pZCB7XG4gICAgY29uc3QgdG9wU3RhcnRPZmZzZXRTaXplID0ge1xuICAgICAgdG9wOiB0aGlzLmNvbmZpZy5nYXAsXG4gICAgICBib3R0b206IHRoaXMuY29uZmlnLmdhcCxcbiAgICB9O1xuXG4gICAgY29uc3QgdG9wRW5kT2Zmc2V0U2l6ZSA9IHtcbiAgICAgIHRvcDogdGhpcy5jb25maWcuZ2FwLFxuICAgICAgYm90dG9tOiB0aGlzLmNvbmZpZy5nYXAsXG4gICAgfTtcblxuICAgIGxldCBwb3NpdGlvbjogJ3RvcCcgfCAnYm90dG9tJztcblxuICAgIC8vIHVwZGF0ZSB0aGUgcG9zaXRpb24gb2YgdGhlIHRvYXN0c1xuICAgIGZvciAoY29uc3QgdG9hc3Qgb2YgdGhpcy50b2FzdHMpIHtcbiAgICAgIC8vIEdldHRpbmcgdGhlIGFwcGxpZWQgZ3Jhdml0eVxuICAgICAgcG9zaXRpb24gPSB0b2FzdC5ncmF2aXR5O1xuXG4gICAgICBjb25zdCBoZWlnaHQgPSB0b2FzdC5oZWlnaHQ7XG5cbiAgICAgIGlmICh0b2FzdC5wb3NpdGlvbiA9PT0gJ3N0YXJ0Jykge1xuICAgICAgICB0b2FzdC5zZXRJbnNldChwb3NpdGlvbiwgYCR7dG9wU3RhcnRPZmZzZXRTaXplW3Bvc2l0aW9uXX1weGApO1xuICAgICAgICB0b3BTdGFydE9mZnNldFNpemVbcG9zaXRpb25dICs9IGhlaWdodCArIHRoaXMuY29uZmlnLmdhcDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRvYXN0LnNldEluc2V0KHBvc2l0aW9uLCBgJHt0b3BFbmRPZmZzZXRTaXplW3Bvc2l0aW9uXX1weGApO1xuICAgICAgICB0b3BFbmRPZmZzZXRTaXplW3Bvc2l0aW9uXSArPSBoZWlnaHQgKyB0aGlzLmNvbmZpZy5nYXA7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=