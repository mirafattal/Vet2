import { Inject, Injectable, InjectionToken } from '@angular/core';
import { BehaviorSubject, from, of } from 'rxjs';
import { catchError, first, map, mergeAll, switchMap } from 'rxjs/operators';
import { isBoolean, isFunction, transformStringToArray } from '../utils/utils';
import * as i0 from "@angular/core";
import * as i1 from "../store/permissions.store";
export const USE_PERMISSIONS_STORE = new InjectionToken('USE_PERMISSIONS_STORE');
export class NgxPermissionsService {
    constructor(isolate = false, permissionsStore) {
        this.isolate = isolate;
        this.permissionsStore = permissionsStore;
        this.permissionsSource = this.isolate ? new BehaviorSubject({}) : this.permissionsStore.permissionsSource;
        this.permissions$ = this.permissionsSource.asObservable();
    }
    /**
     * Remove all permissions from permissions source
     */
    flushPermissions() {
        this.permissionsSource.next({});
    }
    hasPermission(permission) {
        if (!permission || (Array.isArray(permission) && permission.length === 0)) {
            return Promise.resolve(true);
        }
        permission = transformStringToArray(permission);
        return this.hasArrayPermission(permission);
    }
    loadPermissions(permissions, validationFunction) {
        const newPermissions = permissions.reduce((source, name) => this.reducePermission(source, name, validationFunction), {});
        this.permissionsSource.next(newPermissions);
    }
    addPermission(permission, validationFunction) {
        if (Array.isArray(permission)) {
            const permissions = permission.reduce((source, name) => this.reducePermission(source, name, validationFunction), this.permissionsSource.value);
            this.permissionsSource.next(permissions);
        }
        else {
            const permissions = this.reducePermission(this.permissionsSource.value, permission, validationFunction);
            this.permissionsSource.next(permissions);
        }
    }
    removePermission(permissionName) {
        const permissions = {
            ...this.permissionsSource.value
        };
        delete permissions[permissionName];
        this.permissionsSource.next(permissions);
    }
    getPermission(name) {
        return this.permissionsSource.value[name];
    }
    getPermissions() {
        return this.permissionsSource.value;
    }
    reducePermission(source, name, validationFunction) {
        if (!!validationFunction && isFunction(validationFunction)) {
            return {
                ...source,
                [name]: { name, validationFunction }
            };
        }
        return {
            ...source,
            [name]: { name }
        };
    }
    hasArrayPermission(permissions) {
        const promises = permissions.map(key => {
            if (this.hasPermissionValidationFunction(key)) {
                const validationFunction = this.permissionsSource.value[key].validationFunction;
                const immutableValue = { ...this.permissionsSource.value };
                return of(null).pipe(map(() => validationFunction(key, immutableValue)), switchMap((promise) => isBoolean(promise) ?
                    of(promise) : promise), catchError(() => of(false)));
            }
            // check for name of the permission if there is no validation function
            return of(!!this.permissionsSource.value[key]);
        });
        return from(promises).pipe(mergeAll(), first((data) => data !== false, false), map((data) => data !== false)).toPromise().then((data) => data);
    }
    hasPermissionValidationFunction(key) {
        return !!this.permissionsSource.value[key] &&
            !!this.permissionsSource.value[key].validationFunction &&
            isFunction(this.permissionsSource.value[key].validationFunction);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgxPermissionsService, deps: [{ token: USE_PERMISSIONS_STORE }, { token: i1.NgxPermissionsStore }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgxPermissionsService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgxPermissionsService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [USE_PERMISSIONS_STORE]
                }] }, { type: i1.NgxPermissionsStore }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1wZXJtaXNzaW9ucy9zcmMvbGliL3NlcnZpY2UvcGVybWlzc2lvbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFbkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQStCLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5RSxPQUFPLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTTdFLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLHNCQUFzQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7OztBQU0vRSxNQUFNLENBQUMsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLGNBQWMsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBR2pGLE1BQU0sT0FBTyxxQkFBcUI7SUFLOUIsWUFDMkMsVUFBbUIsS0FBSyxFQUN2RCxnQkFBcUM7UUFETixZQUFPLEdBQVAsT0FBTyxDQUFpQjtRQUN2RCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQXFCO1FBRTdDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLGVBQWUsQ0FBdUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQztRQUNoSSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUM5RCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxnQkFBZ0I7UUFDbkIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxF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K0JBQStCLENBQUMsR0FBVztRQUMvQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztZQUN0QyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxrQkFBa0I7WUFDdEQsVUFBVSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUN6RSxDQUFDOzhHQTVHUSxxQkFBcUIsa0JBTWxCLHFCQUFxQjtrSEFOeEIscUJBQXFCOzsyRkFBckIscUJBQXFCO2tCQURqQyxVQUFVOzswQkFPRixNQUFNOzJCQUFDLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBmcm9tLCBPYnNlcnZhYmxlLCBPYnNlcnZhYmxlSW5wdXQsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBmaXJzdCwgbWFwLCBtZXJnZUFsbCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBOZ3hQZXJtaXNzaW9uIH0gZnJvbSAnLi4vbW9kZWwvcGVybWlzc2lvbi5tb2RlbCc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uRm4gfSBmcm9tICcuLi9tb2RlbC9wZXJtaXNzaW9ucy1yb3V0ZXItZGF0YS5tb2RlbCc7XG5pbXBvcnQgeyBOZ3hQZXJtaXNzaW9uc1N0b3JlIH0gZnJvbSAnLi4vc3RvcmUvcGVybWlzc2lvbnMuc3RvcmUnO1xuXG5pbXBvcnQgeyBpc0Jvb2xlYW4sIGlzRnVuY3Rpb24sIHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkgfSBmcm9tICcuLi91dGlscy91dGlscyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmd4UGVybWlzc2lvbnNPYmplY3Qge1xuICAgIFtuYW1lOiBzdHJpbmddOiBOZ3hQZXJtaXNzaW9uO1xufVxuXG5leHBvcnQgY29uc3QgVVNFX1BFUk1JU1NJT05TX1NUT1JFID0gbmV3IEluamVjdGlvblRva2VuKCdVU0VfUEVSTUlTU0lPTlNfU1RPUkUnKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5neFBlcm1pc3Npb25zU2VydmljZSB7XG5cbiAgICBwcml2YXRlIHBlcm1pc3Npb25zU291cmNlOiBCZWhhdmlvclN1YmplY3Q8Tmd4UGVybWlzc2lvbnNPYmplY3Q+O1xuICAgIHB1YmxpYyBwZXJtaXNzaW9ucyQ6IE9ic2VydmFibGU8Tmd4UGVybWlzc2lvbnNPYmplY3Q+O1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIEBJbmplY3QoVVNFX1BFUk1JU1NJT05TX1NUT1JFKSBwcml2YXRlIGlzb2xhdGU6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICAgICAgcHJpdmF0ZSBwZXJtaXNzaW9uc1N0b3JlOiBOZ3hQZXJtaXNzaW9uc1N0b3JlXG4gICAgKSB7XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNTb3VyY2UgPSB0aGlzLmlzb2xhdGUgPyBuZXcgQmVoYXZpb3JTdWJqZWN0PE5neFBlcm1pc3Npb25zT2JqZWN0Pih7fSkgOiB0aGlzLnBlcm1pc3Npb25zU3RvcmUucGVybWlzc2lvbnNTb3VyY2U7XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnMkID0gdGhpcy5wZXJtaXNzaW9uc1NvdXJjZS5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYWxsIHBlcm1pc3Npb25zIGZyb20gcGVybWlzc2lvbnMgc291cmNlXG4gICAgICovXG4gICAgcHVibGljIGZsdXNoUGVybWlzc2lvbnMoKTogdm9pZCB7XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNTb3VyY2UubmV4dCh7fSk7XG4gICAgfVxuXG4gICAgcHVibGljIGhhc1Blcm1pc3Npb24ocGVybWlzc2lvbjogc3RyaW5nIHwgc3RyaW5nW10pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgaWYgKCFwZXJtaXNzaW9uIHx8IChBcnJheS5pc0FycmF5KHBlcm1pc3Npb24pICYmIHBlcm1pc3Npb24ubGVuZ3RoID09PSAwKSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHBlcm1pc3Npb24gPSB0cmFuc2Zvcm1TdHJpbmdUb0FycmF5KHBlcm1pc3Npb24pO1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNBcnJheVBlcm1pc3Npb24ocGVybWlzc2lvbik7XG4gICAgfVxuXG4gICAgcHVibGljIGxvYWRQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogc3RyaW5nW10sIHZhbGlkYXRpb25GdW5jdGlvbj86IFZhbGlkYXRpb25Gbik6IHZvaWQge1xuICAgICAgICBjb25zdCBuZXdQZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zLnJlZHVjZShcbiAgICAgICAgICAgIChzb3VyY2UsIG5hbWUpID0+IHRoaXMucmVkdWNlUGVybWlzc2lvbihzb3VyY2UsIG5hbWUsIHZhbGlkYXRpb25GdW5jdGlvbiksIHt9XG4gICAgICAgICk7XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNTb3VyY2UubmV4dChuZXdQZXJtaXNzaW9ucyk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZFBlcm1pc3Npb24ocGVybWlzc2lvbjogc3RyaW5nIHwgc3RyaW5nW10sIHZhbGlkYXRpb25GdW5jdGlvbj86IFZhbGlkYXRpb25Gbik6IHZvaWQge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwZXJtaXNzaW9uKSkge1xuICAgICAgICAgICAgY29uc3QgcGVybWlzc2lvbnMgPSBwZXJtaXNzaW9uLnJlZHVjZShcbiAgICAgICAgICAgICAgICAoc291cmNlLCBuYW1lKSA9PiB0aGlzLnJlZHVjZVBlcm1pc3Npb24oc291cmNlLCBuYW1lLCB2YWxpZGF0aW9uRnVuY3Rpb24pLCB0aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU291cmNlLm5leHQocGVybWlzc2lvbnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgcGVybWlzc2lvbnMgPSB0aGlzLnJlZHVjZVBlcm1pc3Npb24odGhpcy5wZXJtaXNzaW9uc1NvdXJjZS52YWx1ZSwgcGVybWlzc2lvbiwgdmFsaWRhdGlvbkZ1bmN0aW9uKTtcblxuICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NvdXJjZS5uZXh0KHBlcm1pc3Npb25zKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyByZW1vdmVQZXJtaXNzaW9uKHBlcm1pc3Npb25OYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbnMgPSB7XG4gICAgICAgICAgICAuLi50aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlXG4gICAgICAgIH07XG4gICAgICAgIGRlbGV0ZSBwZXJtaXNzaW9uc1twZXJtaXNzaW9uTmFtZV07XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNTb3VyY2UubmV4dChwZXJtaXNzaW9ucyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFBlcm1pc3Npb24obmFtZTogc3RyaW5nKTogTmd4UGVybWlzc2lvbiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlW25hbWVdO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRQZXJtaXNzaW9ucygpOiBOZ3hQZXJtaXNzaW9uc09iamVjdCB7XG4gICAgICAgIHJldHVybiB0aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVkdWNlUGVybWlzc2lvbihzb3VyY2U6IE5neFBlcm1pc3Npb25zT2JqZWN0LCBuYW1lOiBzdHJpbmcsIHZhbGlkYXRpb25GdW5jdGlvbj86IFZhbGlkYXRpb25Gbik6IE5neFBlcm1pc3Npb25zT2JqZWN0IHtcbiAgICAgICAgaWYgKCEhdmFsaWRhdGlvbkZ1bmN0aW9uICYmIGlzRnVuY3Rpb24odmFsaWRhdGlvbkZ1bmN0aW9uKSkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAuLi5zb3VyY2UsXG4gICAgICAgICAgICAgICAgW25hbWVdOiB7bmFtZSwgdmFsaWRhdGlvbkZ1bmN0aW9ufVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4uc291cmNlLFxuICAgICAgICAgICAgW25hbWVdOiB7bmFtZX1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc0FycmF5UGVybWlzc2lvbihwZXJtaXNzaW9uczogc3RyaW5nW10pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgcHJvbWlzZXM6IE9ic2VydmFibGU8Ym9vbGVhbj5bXSA9IHBlcm1pc3Npb25zLm1hcChrZXkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuaGFzUGVybWlzc2lvblZhbGlkYXRpb25GdW5jdGlvbihrZXkpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdGlvbkZ1bmN0aW9uID0gdGhpcy5wZXJtaXNzaW9uc1NvdXJjZS52YWx1ZVtrZXldLnZhbGlkYXRpb25GdW5jdGlvbjtcbiAgICAgICAgICAgICAgICBjb25zdCBpbW11dGFibGVWYWx1ZSA9IHsuLi50aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlfTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBvZihudWxsKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICBtYXAoKCkgPT4gdmFsaWRhdGlvbkZ1bmN0aW9uKGtleSwgaW1tdXRhYmxlVmFsdWUpKSxcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKChwcm9taXNlOiBQcm9taXNlPGJvb2xlYW4+IHwgYm9vbGVhbik6IE9ic2VydmFibGVJbnB1dDxib29sZWFuPiA9PiBpc0Jvb2xlYW4ocHJvbWlzZSkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgb2YocHJvbWlzZSBhcyBib29sZWFuKSA6IHByb21pc2UgYXMgUHJvbWlzZTxib29sZWFuPiksXG4gICAgICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gb2YoZmFsc2UpKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGNoZWNrIGZvciBuYW1lIG9mIHRoZSBwZXJtaXNzaW9uIGlmIHRoZXJlIGlzIG5vIHZhbGlkYXRpb24gZnVuY3Rpb25cbiAgICAgICAgICAgIHJldHVybiBvZighIXRoaXMucGVybWlzc2lvbnNTb3VyY2UudmFsdWVba2V5XSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBmcm9tKHByb21pc2VzKS5waXBlKFxuICAgICAgICAgICAgbWVyZ2VBbGwoKSxcbiAgICAgICAgICAgIGZpcnN0KChkYXRhKSA9PiBkYXRhICE9PSBmYWxzZSwgZmFsc2UpLFxuICAgICAgICAgICAgbWFwKChkYXRhKSA9PiBkYXRhICE9PSBmYWxzZSlcbiAgICAgICAgKS50b1Byb21pc2UoKS50aGVuKChkYXRhOiBhbnkpID0+IGRhdGEpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzUGVybWlzc2lvblZhbGlkYXRpb25GdW5jdGlvbihrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gISF0aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlW2tleV0gJiZcbiAgICAgICAgICAgICEhdGhpcy5wZXJtaXNzaW9uc1NvdXJjZS52YWx1ZVtrZXldLnZhbGlkYXRpb25GdW5jdGlvbiAmJlxuICAgICAgICAgICAgaXNGdW5jdGlvbih0aGlzLnBlcm1pc3Npb25zU291cmNlLnZhbHVlW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uKTtcbiAgICB9XG5cbn1cbiJdfQ==