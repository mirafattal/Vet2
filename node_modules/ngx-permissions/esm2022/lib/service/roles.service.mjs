import { Inject, Injectable, InjectionToken } from '@angular/core';
import { BehaviorSubject, from, of } from 'rxjs';
import { catchError, every, first, map, mergeAll, mergeMap, switchMap } from 'rxjs/operators';
import { isBoolean, isFunction, isPromise, transformStringToArray } from '../utils/utils';
import * as i0 from "@angular/core";
import * as i1 from "../store/roles.store";
import * as i2 from "./permissions.service";
export const USE_ROLES_STORE = new InjectionToken('USE_ROLES_STORE');
export class NgxRolesService {
    constructor(isolate = false, rolesStore, permissionsService) {
        this.isolate = isolate;
        this.rolesStore = rolesStore;
        this.permissionsService = permissionsService;
        this.rolesSource = this.isolate ? new BehaviorSubject({}) : this.rolesStore.rolesSource;
        this.roles$ = this.rolesSource.asObservable();
    }
    addRole(name, validationFunction) {
        const roles = {
            ...this.rolesSource.value,
            [name]: { name, validationFunction }
        };
        this.rolesSource.next(roles);
    }
    addRoleWithPermissions(name, permissions) {
        this.permissionsService.addPermission(permissions);
        this.addRole(name, permissions);
    }
    addRoles(rolesObj) {
        Object.keys(rolesObj).forEach((key, index) => {
            this.addRole(key, rolesObj[key]);
        });
    }
    addRolesWithPermissions(rolesObj) {
        Object.keys(rolesObj).forEach((key, index) => {
            this.addRoleWithPermissions(key, rolesObj[key]);
        });
    }
    flushRoles() {
        this.rolesSource.next({});
    }
    flushRolesAndPermissions() {
        this.flushRoles();
        this.permissionsService.flushPermissions();
    }
    removeRole(roleName) {
        const roles = {
            ...this.rolesSource.value
        };
        delete roles[roleName];
        this.rolesSource.next(roles);
    }
    getRoles() {
        return this.rolesSource.value;
    }
    getRole(name) {
        return this.rolesSource.value[name];
    }
    hasOnlyRoles(names) {
        const isNamesEmpty = !names || (Array.isArray(names) && names.length === 0);
        if (isNamesEmpty) {
            return Promise.resolve(true);
        }
        names = transformStringToArray(names);
        return Promise.all([this.hasRoleKey(names), this.hasRolePermission(this.rolesSource.value, names)])
            .then(([hasRoles, hasPermissions]) => {
            return hasRoles || hasPermissions;
        });
    }
    hasRoleKey(roleName) {
        const promises = roleName.map((key) => {
            const hasValidationFunction = !!this.rolesSource.value[key] &&
                !!this.rolesSource.value[key].validationFunction &&
                isFunction(this.rolesSource.value[key].validationFunction);
            if (hasValidationFunction && !isPromise(this.rolesSource.value[key].validationFunction)) {
                const validationFunction = this.rolesSource.value[key].validationFunction;
                const immutableValue = { ...this.rolesSource.value };
                return of(null).pipe(map(() => validationFunction(key, immutableValue)), switchMap((promise) => isBoolean(promise) ?
                    of(promise) : promise), catchError(() => of(false)));
            }
            return of(false);
        });
        return from(promises).pipe(mergeAll(), first((data) => data !== false, false), map((data) => data !== false)).toPromise().then((data) => data);
    }
    hasRolePermission(roles, roleNames) {
        return from(roleNames).pipe(mergeMap((key) => {
            if (roles[key] && Array.isArray(roles[key].validationFunction)) {
                return from(roles[key].validationFunction).pipe(mergeMap((permission) => this.permissionsService.hasPermission(permission)), every(hasPermission => hasPermission === true));
            }
            return of(false);
        }), first(hasPermission => hasPermission === true, false)).toPromise();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgxRolesService, deps: [{ token: USE_ROLES_STORE }, { token: i1.NgxRolesStore }, { token: i2.NgxPermissionsService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgxRolesService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgxRolesService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [USE_ROLES_STORE]
                }] }, { type: i1.NgxRolesStore }, { type: i2.NgxPermissionsService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm9sZXMuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1wZXJtaXNzaW9ucy9zcmMvbGliL3NlcnZpY2Uvcm9sZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFbkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQStCLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5RSxPQUFPLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLOUYsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7QUFHMUYsTUFBTSxDQUFDLE1BQU0sZUFBZSxHQUFHLElBQUksY0FBYyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFPckUsTUFBTSxPQUFPLGVBQWU7SUFNeEIsWUFDcUMsVUFBbUIsS0FBSyxFQUNqRCxVQUF5QixFQUN6QixrQkFBeUM7UUFGaEIsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFDakQsZUFBVSxHQUFWLFVBQVUsQ0FBZTtRQUN6Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQXVCO1FBRWpELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxlQUFlLENBQWlCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUN4RyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDbEQsQ0FBQztJQUVNLE9BQU8sQ0FBQyxJ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QUFlOzsyRkFBZixlQUFlO2tCQUQzQixVQUFVOzswQkFRRixNQUFNOzJCQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZnJvbSwgT2JzZXJ2YWJsZSwgT2JzZXJ2YWJsZUlucHV0LCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgZXZlcnksIGZpcnN0LCBtYXAsIG1lcmdlQWxsLCBtZXJnZU1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbkZuIH0gZnJvbSAnLi4vbW9kZWwvcGVybWlzc2lvbnMtcm91dGVyLWRhdGEubW9kZWwnO1xuXG5pbXBvcnQgeyBOZ3hSb2xlIH0gZnJvbSAnLi4vbW9kZWwvcm9sZS5tb2RlbCc7XG5pbXBvcnQgeyBOZ3hSb2xlc1N0b3JlIH0gZnJvbSAnLi4vc3RvcmUvcm9sZXMuc3RvcmUnO1xuaW1wb3J0IHsgaXNCb29sZWFuLCBpc0Z1bmN0aW9uLCBpc1Byb21pc2UsIHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkgfSBmcm9tICcuLi91dGlscy91dGlscyc7XG5pbXBvcnQgeyBOZ3hQZXJtaXNzaW9uc1NlcnZpY2UgfSBmcm9tICcuL3Blcm1pc3Npb25zLnNlcnZpY2UnO1xuXG5leHBvcnQgY29uc3QgVVNFX1JPTEVTX1NUT1JFID0gbmV3IEluamVjdGlvblRva2VuKCdVU0VfUk9MRVNfU1RPUkUnKTtcblxuZXhwb3J0IGludGVyZmFjZSBOZ3hSb2xlc09iamVjdCB7XG4gICAgW25hbWU6IHN0cmluZ106IE5neFJvbGU7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOZ3hSb2xlc1NlcnZpY2Uge1xuXG4gICAgcHJpdmF0ZSByb2xlc1NvdXJjZTogQmVoYXZpb3JTdWJqZWN0PE5neFJvbGVzT2JqZWN0PjtcblxuICAgIHB1YmxpYyByb2xlcyQ6IE9ic2VydmFibGU8Tmd4Um9sZXNPYmplY3Q+O1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIEBJbmplY3QoVVNFX1JPTEVTX1NUT1JFKSBwcml2YXRlIGlzb2xhdGU6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICAgICAgcHJpdmF0ZSByb2xlc1N0b3JlOiBOZ3hSb2xlc1N0b3JlLFxuICAgICAgICBwcml2YXRlIHBlcm1pc3Npb25zU2VydmljZTogTmd4UGVybWlzc2lvbnNTZXJ2aWNlXG4gICAgKSB7XG4gICAgICAgIHRoaXMucm9sZXNTb3VyY2UgPSB0aGlzLmlzb2xhdGUgPyBuZXcgQmVoYXZpb3JTdWJqZWN0PE5neFJvbGVzT2JqZWN0Pih7fSkgOiB0aGlzLnJvbGVzU3RvcmUucm9sZXNTb3VyY2U7XG4gICAgICAgIHRoaXMucm9sZXMkID0gdGhpcy5yb2xlc1NvdXJjZS5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkUm9sZShuYW1lOiBzdHJpbmcsIHZhbGlkYXRpb25GdW5jdGlvbjogVmFsaWRhdGlvbkZuIHwgc3RyaW5nW10pIHtcbiAgICAgICAgY29uc3Qgcm9sZXMgPSB7XG4gICAgICAgICAgICAuLi50aGlzLnJvbGVzU291cmNlLnZhbHVlLFxuICAgICAgICAgICAgW25hbWVdOiB7bmFtZSwgdmFsaWRhdGlvbkZ1bmN0aW9ufVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnJvbGVzU291cmNlLm5leHQocm9sZXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRSb2xlV2l0aFBlcm1pc3Npb25zKG5hbWU6IHN0cmluZywgcGVybWlzc2lvbnM6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmFkZFBlcm1pc3Npb24ocGVybWlzc2lvbnMpO1xuICAgICAgICB0aGlzLmFkZFJvbGUobmFtZSwgcGVybWlzc2lvbnMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRSb2xlcyhyb2xlc09iajogeyBbbmFtZTogc3RyaW5nXTogVmFsaWRhdGlvbkZuIHwgc3RyaW5nW10gfSkge1xuICAgICAgICBPYmplY3Qua2V5cyhyb2xlc09iaikuZm9yRWFjaCgoa2V5LCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hZGRSb2xlKGtleSwgcm9sZXNPYmpba2V5XSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRSb2xlc1dpdGhQZXJtaXNzaW9ucyhyb2xlc09iajogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nW10gfSkge1xuICAgICAgICBPYmplY3Qua2V5cyhyb2xlc09iaikuZm9yRWFjaCgoa2V5LCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hZGRSb2xlV2l0aFBlcm1pc3Npb25zKGtleSwgcm9sZXNPYmpba2V5XSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmbHVzaFJvbGVzKCkge1xuICAgICAgICB0aGlzLnJvbGVzU291cmNlLm5leHQoe30pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmbHVzaFJvbGVzQW5kUGVybWlzc2lvbnMoKSB7XG4gICAgICAgIHRoaXMuZmx1c2hSb2xlcygpO1xuICAgICAgICB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5mbHVzaFBlcm1pc3Npb25zKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbW92ZVJvbGUocm9sZU5hbWU6IHN0cmluZykge1xuICAgICAgICBjb25zdCByb2xlcyA9IHtcbiAgICAgICAgICAgIC4uLnRoaXMucm9sZXNTb3VyY2UudmFsdWVcbiAgICAgICAgfTtcbiAgICAgICAgZGVsZXRlIHJvbGVzW3JvbGVOYW1lXTtcbiAgICAgICAgdGhpcy5yb2xlc1NvdXJjZS5uZXh0KHJvbGVzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Um9sZXMoKTogTmd4Um9sZXNPYmplY3Qge1xuICAgICAgICByZXR1cm4gdGhpcy5yb2xlc1NvdXJjZS52YWx1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0Um9sZShuYW1lOiBzdHJpbmcpOiBOZ3hSb2xlIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucm9sZXNTb3VyY2UudmFsdWVbbmFtZV07XG4gICAgfVxuXG4gICAgcHVibGljIGhhc09ubHlSb2xlcyhuYW1lczogc3RyaW5nIHwgc3RyaW5nW10pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgaXNOYW1lc0VtcHR5ID0gIW5hbWVzIHx8IChBcnJheS5pc0FycmF5KG5hbWVzKSAmJiBuYW1lcy5sZW5ndGggPT09IDApO1xuXG4gICAgICAgIGlmIChpc05hbWVzRW1wdHkpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBuYW1lcyA9IHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkobmFtZXMpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbdGhpcy5oYXNSb2xlS2V5KG5hbWVzKSwgdGhpcy5oYXNSb2xlUGVybWlzc2lvbih0aGlzLnJvbGVzU291cmNlLnZhbHVlLCBuYW1lcyldKVxuICAgICAgICAgICAgLnRoZW4oKFtoYXNSb2xlcywgaGFzUGVybWlzc2lvbnNdOiBbYm9vbGVhbiwgYm9vbGVhbl0pID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gaGFzUm9sZXMgfHwgaGFzUGVybWlzc2lvbnM7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc1JvbGVLZXkocm9sZU5hbWU6IHN0cmluZ1tdKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IHByb21pc2VzOiBPYnNlcnZhYmxlPGJvb2xlYW4+W10gPSByb2xlTmFtZS5tYXAoKGtleSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaGFzVmFsaWRhdGlvbkZ1bmN0aW9uID0gISF0aGlzLnJvbGVzU291cmNlLnZhbHVlW2tleV0gJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICEhdGhpcy5yb2xlc1NvdXJjZS52YWx1ZVtrZXldLnZhbGlkYXRpb25GdW5jdGlvbiAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNGdW5jdGlvbih0aGlzLnJvbGVzU291cmNlLnZhbHVlW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uKTtcblxuICAgICAgICAgICAgaWYgKGhhc1ZhbGlkYXRpb25GdW5jdGlvbiAmJiAhaXNQcm9taXNlKHRoaXMucm9sZXNTb3VyY2UudmFsdWVba2V5XS52YWxpZGF0aW9uRnVuY3Rpb24pKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdGlvbkZ1bmN0aW9uID0gdGhpcy5yb2xlc1NvdXJjZS52YWx1ZVtrZXldLnZhbGlkYXRpb25GdW5jdGlvbiBhcyBWYWxpZGF0aW9uRm47XG4gICAgICAgICAgICAgICAgY29uc3QgaW1tdXRhYmxlVmFsdWUgPSB7Li4udGhpcy5yb2xlc1NvdXJjZS52YWx1ZX07XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gb2YobnVsbCkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgbWFwKCgpID0+IHZhbGlkYXRpb25GdW5jdGlvbihrZXksIGltbXV0YWJsZVZhbHVlKSksXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgocHJvbWlzZTogUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW4pOiBPYnNlcnZhYmxlSW5wdXQ8Ym9vbGVhbj4gPT4gaXNCb29sZWFuKHByb21pc2UpID9cbiAgICAgICAgICAgICAgICAgICAgICAgIG9mKHByb21pc2UgYXMgYm9vbGVhbikgOiBwcm9taXNlIGFzIFByb21pc2U8Ym9vbGVhbj4pLFxuICAgICAgICAgICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKGZhbHNlKSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gZnJvbShwcm9taXNlcykucGlwZShcbiAgICAgICAgICAgIG1lcmdlQWxsKCksXG4gICAgICAgICAgICBmaXJzdCgoZGF0YTogYW55KSA9PiBkYXRhICE9PSBmYWxzZSwgZmFsc2UpLFxuICAgICAgICAgICAgbWFwKChkYXRhKSA9PiBkYXRhICE9PSBmYWxzZSlcbiAgICAgICAgKS50b1Byb21pc2UoKS50aGVuKChkYXRhOiBhbnkpID0+IGRhdGEpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzUm9sZVBlcm1pc3Npb24ocm9sZXM6IE5neFJvbGVzT2JqZWN0LCByb2xlTmFtZXM6IHN0cmluZ1tdKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiBmcm9tKHJvbGVOYW1lcykucGlwZShcbiAgICAgICAgICAgIG1lcmdlTWFwKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocm9sZXNba2V5XSAmJiBBcnJheS5pc0FycmF5KHJvbGVzW2tleV0udmFsaWRhdGlvbkZ1bmN0aW9uKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJvbSg8c3RyaW5nW10+cm9sZXNba2V5XS52YWxpZGF0aW9uRnVuY3Rpb24pLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXJnZU1hcCgocGVybWlzc2lvbikgPT4gdGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UuaGFzUGVybWlzc2lvbihwZXJtaXNzaW9uKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVyeShoYXNQZXJtaXNzaW9uID0+IGhhc1Blcm1pc3Npb24gPT09IHRydWUpXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgZmlyc3QoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSB0cnVlLCBmYWxzZSlcbiAgICAgICAgKS50b1Byb21pc2UoKTtcbiAgICB9XG5cbn1cbiJdfQ==