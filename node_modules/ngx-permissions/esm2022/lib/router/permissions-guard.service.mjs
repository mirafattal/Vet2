import { inject, Injectable } from '@angular/core';
import { RouterStateSnapshot } from '@angular/router';
import { forkJoin, from, of } from 'rxjs';
import { first, mergeMap, tap } from 'rxjs/operators';
import { DEFAULT_REDIRECT_KEY } from '../model/permissions-router-data.model';
import { isFunction, isPlainObject, transformStringToArray } from '../utils/utils';
import * as i0 from "@angular/core";
import * as i1 from "../service/permissions.service";
import * as i2 from "../service/roles.service";
import * as i3 from "@angular/router";
export const ngxPermissionsGuard = (route, state) => {
    const permissionsGuard = inject(NgxPermissionsGuard);
    if (state instanceof RouterStateSnapshot) {
        return permissionsGuard.hasPermissions(route, state);
    }
    return permissionsGuard.hasPermissions(route);
};
/**
 * @deprecated Use {@link ngxPermissionsGuard} instead
 */
export class NgxPermissionsGuard {
    constructor(permissionsService, rolesService, router) {
        this.permissionsService = permissionsService;
        this.rolesService = rolesService;
        this.router = router;
    }
    canActivate(route, state) {
        return this.hasPermissions(route, state);
    }
    canActivateChild(childRoute, state) {
        return this.hasPermissions(childRoute, state);
    }
    canLoad(route) {
        return this.hasPermissions(route);
    }
    canMatch(route) {
        return this.hasPermissions(route);
    }
    hasPermissions(route, state) {
        const routeDataPermissions = !!route && route.data ? route.data['permissions'] : {};
        const permissions = this.transformPermission(routeDataPermissions, route, state);
        if (this.isParameterAvailable(permissions.except)) {
            return this.passingExceptPermissionsValidation(permissions, route, state);
        }
        if (this.isParameterAvailable(permissions.only)) {
            return this.passingOnlyPermissionsValidation(permissions, route, state);
        }
        return true;
    }
    transformPermission(permissions, route, state) {
        const only = isFunction(permissions.only)
            ? permissions.only(route, state)
            : transformStringToArray(permissions.only);
        const except = isFunction(permissions.except)
            ? permissions.except(route, state)
            : transformStringToArray(permissions.except);
        const redirectTo = permissions.redirectTo;
        return {
            only,
            except,
            redirectTo
        };
    }
    isParameterAvailable(permission) {
        return !!permission && permission.length > 0;
    }
    passingExceptPermissionsValidation(permissions, route, state) {
        if (!!permissions.redirectTo
            && ((isFunction(permissions.redirectTo))
                || (isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo)))) {
            let failedPermission = '';
            return from(permissions.except)
                .pipe(mergeMap(permissionsExcept => {
                return forkJoin([
                    this.permissionsService.hasPermission(permissionsExcept),
                    this.rolesService.hasOnlyRoles(permissionsExcept)
                ]).pipe(tap(hasPermissions => {
                    const dontHavePermissions = hasPermissions.every(hasPermission => hasPermission === false);
                    if (!dontHavePermissions) {
                        failedPermission = permissionsExcept;
                    }
                }));
            }), first(hasPermissions => hasPermissions.some(hasPermission => hasPermission === true), false), mergeMap(isAllFalse => {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
                if (!isAllFalse && permissions.only) {
                    return this.onlyRedirectCheck(permissions, route, state);
                }
                return of(!isAllFalse);
            }))
                .toPromise();
        }
        return Promise.all([
            this.permissionsService.hasPermission(permissions.except),
            this.rolesService.hasOnlyRoles(permissions.except)
        ]).then(([hasPermission, hasRoles]) => {
            if (hasPermission || hasRoles) {
                if (permissions.redirectTo) {
                    this.redirectToAnotherRoute(permissions.redirectTo, route, state);
                }
                return false;
            }
            if (permissions.only) {
                return this.checkOnlyPermissions(permissions, route, state);
            }
            return true;
        });
    }
    redirectToAnotherRoute(permissionRedirectTo, route, state, failedPermissionName) {
        const redirectTo = isFunction(permissionRedirectTo)
            ? permissionRedirectTo(failedPermissionName, route, state)
            : permissionRedirectTo;
        if (this.isRedirectionWithParameters(redirectTo)) {
            redirectTo.navigationCommands = this.transformNavigationCommands(redirectTo.navigationCommands, route, state);
            redirectTo.navigationExtras = this.transformNavigationExtras(redirectTo.navigationExtras, route, state);
            this.router.navigate(redirectTo.navigationCommands, redirectTo.navigationExtras);
            return;
        }
        if (Array.isArray(redirectTo)) {
            this.router.navigate(redirectTo);
        }
        else {
            this.router.navigate([redirectTo]);
        }
    }
    isRedirectionWithParameters(object) {
        return (isPlainObject(object) && (!!object.navigationCommands || !!object.navigationExtras));
    }
    transformNavigationCommands(navigationCommands, route, state) {
        return isFunction(navigationCommands)
            ? navigationCommands(route, state)
            : navigationCommands;
    }
    transformNavigationExtras(navigationExtras, route, state) {
        return isFunction(navigationExtras)
            ? navigationExtras(route, state)
            : navigationExtras;
    }
    onlyRedirectCheck(permissions, route, state) {
        let failedPermission = '';
        return from(permissions.only)
            .pipe(mergeMap(permissionsOnly => {
            return forkJoin([
                this.permissionsService.hasPermission(permissionsOnly),
                this.rolesService.hasOnlyRoles(permissionsOnly)
            ]).pipe(tap(hasPermissions => {
                const failed = hasPermissions.every(hasPermission => hasPermission === false);
                if (failed) {
                    failedPermission = permissionsOnly;
                }
            }));
        }), first(hasPermissions => {
            if (isFunction(permissions.redirectTo)) {
                return hasPermissions.some(hasPermission => hasPermission === true);
            }
            return hasPermissions.every(hasPermission => hasPermission === false);
        }, false), mergeMap((pass) => {
            if (isFunction(permissions.redirectTo)) {
                if (pass) {
                    return of(true);
                }
                else {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
            }
            else {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                }
                return of(!pass);
            }
        }))
            .toPromise();
    }
    handleRedirectOfFailedPermission(permissions, failedPermission, route, state) {
        if (this.isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission)) {
            this.redirectToAnotherRoute(permissions.redirectTo[failedPermission], route, state, failedPermission);
        }
        else {
            if (isFunction(permissions.redirectTo)) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state, failedPermission);
            }
            else {
                this.redirectToAnotherRoute(permissions.redirectTo[DEFAULT_REDIRECT_KEY], route, state, failedPermission);
            }
        }
    }
    isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission) {
        return (!!permissions.redirectTo && permissions.redirectTo[failedPermission]);
    }
    checkOnlyPermissions(purePermissions, route, state) {
        const permissions = {
            ...purePermissions
        };
        return Promise.all([
            this.permissionsService.hasPermission(permissions.only),
            this.rolesService.hasOnlyRoles(permissions.only)
        ]).then(([hasPermission, hasRole]) => {
            if (hasPermission || hasRole) {
                return true;
            }
            if (permissions.redirectTo) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state);
            }
            return false;
        });
    }
    passingOnlyPermissionsValidation(permissions, route, state) {
        if ((isFunction(permissions.redirectTo)
            || isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo))) {
            return this.onlyRedirectCheck(permissions, route, state);
        }
        return this.checkOnlyPermissions(permissions, route, state);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgxPermissionsGuard, deps: [{ token: i1.NgxPermissionsService }, { token: i2.NgxRolesService }, { token: i3.Router }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgxPermissionsGuard }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgxPermissionsGuard, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i1.NgxPermissionsService }, { type: i2.NgxRolesService }, { type: i3.Router }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMtZ3VhcmQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1wZXJtaXNzaW9ucy9zcmMvbGliL3JvdXRlci9wZXJtaXNzaW9ucy1ndWFyZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFRSCxtQkFBbUIsRUFFdEIsTUFBTSxpQkFBaUIsQ0FBQztBQUV6QixPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdEQsT0FBTyxFQUNILG9CQUFvQixFQVN2QixNQUFNLHdDQUF3QyxDQUFDO0FBR2hELE9BQU8sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLHNCQUFzQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7O0FBUW5GLE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFvRCxDQUFDLEtBQXFDLEVBQUUsS0FBeUMsRUFBRSxFQUFFO0lBQ3JLLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDckQsSUFBSSxLQUFLLFlBQVksbUJBQW1CLEVBQUUsQ0FBQztRQUN2QyxPQUFPLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUNELE9BQU8sZ0JBQWdCLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ2xELENBQUMsQ0FBQTtBQUVEOztHQUVHO0FBRUgsTUFBTSxPQUFPLG1CQUFtQjtJQUU1QixZQUFvQixrQkFBeUMsRUFBVSxZQUE2QixFQUFVLE1BQWM7UUFBeEcsdUJBQWtCLEdBQWxC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QUVPLGdDQUFnQyxDQUNwQyxXQUErQixFQUMvQixLQUFxQyxFQUNyQyxLQUEyQjtRQUUzQixJQUNJLENBQUMsVUFBVSxDQUFlLFdBQVcsQ0FBQyxVQUFVLENBQUM7ZUFDMUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUMsRUFDNUcsQ0FBQztZQUNDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDN0QsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDaEUsQ0FBQzs4R0FuU1EsbUJBQW1CO2tIQUFuQixtQkFBbUI7OzJGQUFuQixtQkFBbUI7a0JBRC9CLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gICAgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCxcbiAgICBDYW5BY3RpdmF0ZUNoaWxkRm4sXG4gICAgQ2FuQWN0aXZhdGVGbixcbiAgICBDYW5NYXRjaEZuLFxuICAgIE5hdmlnYXRpb25FeHRyYXMsXG4gICAgUm91dGUsXG4gICAgUm91dGVyLFxuICAgIFJvdXRlclN0YXRlU25hcHNob3QsXG4gICAgVXJsU2VnbWVudFxufSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuXG5pbXBvcnQgeyBmb3JrSm9pbiwgZnJvbSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpcnN0LCBtZXJnZU1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1xuICAgIERFRkFVTFRfUkVESVJFQ1RfS0VZLFxuICAgIEV4Y2VwdEZuLFxuICAgIE5hdmlnYXRpb25Db21tYW5kc0ZuLFxuICAgIE5hdmlnYXRpb25FeHRyYXNGbixcbiAgICBOZ3hQZXJtaXNzaW9uc1JvdXRlckRhdGEsXG4gICAgTmd4UmVkaXJlY3RUb05hdmlnYXRpb25QYXJhbWV0ZXJzLFxuICAgIE9ubHlGbixcbiAgICBSZWRpcmVjdFRvLFxuICAgIFJlZGlyZWN0VG9GblxufSBmcm9tICcuLi9tb2RlbC9wZXJtaXNzaW9ucy1yb3V0ZXItZGF0YS5tb2RlbCc7XG5pbXBvcnQgeyBOZ3hQZXJtaXNzaW9uc1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlL3Blcm1pc3Npb25zLnNlcnZpY2UnO1xuaW1wb3J0IHsgTmd4Um9sZXNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZS9yb2xlcy5zZXJ2aWNlJztcbmltcG9ydCB7IGlzRnVuY3Rpb24sIGlzUGxhaW5PYmplY3QsIHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkgfSBmcm9tICcuLi91dGlscy91dGlscyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmd4UGVybWlzc2lvbnNEYXRhIHtcbiAgICBvbmx5Pzogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgZXhjZXB0Pzogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgcmVkaXJlY3RUbz86IFJlZGlyZWN0VG8gfCBSZWRpcmVjdFRvRm47XG59XG5cbmV4cG9ydCBjb25zdCBuZ3hQZXJtaXNzaW9uc0d1YXJkOiBDYW5BY3RpdmF0ZUZuIHwgQ2FuQWN0aXZhdGVDaGlsZEZuIHwgQ2FuTWF0Y2hGbiA9IChyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLCBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdCB8IFVybFNlZ21lbnRbXSkgPT4ge1xuICAgIGNvbnN0IHBlcm1pc3Npb25zR3VhcmQgPSBpbmplY3QoTmd4UGVybWlzc2lvbnNHdWFyZCk7XG4gICAgaWYgKHN0YXRlIGluc3RhbmNlb2YgUm91dGVyU3RhdGVTbmFwc2hvdCkge1xuICAgICAgICByZXR1cm4gcGVybWlzc2lvbnNHdWFyZC5oYXNQZXJtaXNzaW9ucyhyb3V0ZSwgc3RhdGUpO1xuICAgIH1cbiAgICByZXR1cm4gcGVybWlzc2lvbnNHdWFyZC5oYXNQZXJtaXNzaW9ucyhyb3V0ZSk7XG59XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayBuZ3hQZXJtaXNzaW9uc0d1YXJkfSBpbnN0ZWFkXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOZ3hQZXJtaXNzaW9uc0d1YXJkIHtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcGVybWlzc2lvbnNTZXJ2aWNlOiBOZ3hQZXJtaXNzaW9uc1NlcnZpY2UsIHByaXZhdGUgcm9sZXNTZXJ2aWNlOiBOZ3hSb2xlc1NlcnZpY2UsIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIpIHtcbiAgICB9XG5cbiAgICBjYW5BY3RpdmF0ZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3QpOiBQcm9taXNlPGJvb2xlYW4+IHwgYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc1Blcm1pc3Npb25zKHJvdXRlLCBzdGF0ZSk7XG4gICAgfVxuXG4gICAgY2FuQWN0aXZhdGVDaGlsZChjaGlsZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdCk6IE9ic2VydmFibGU8Ym9vbGVhbj4gfCBQcm9taXNlPGJvb2xlYW4+IHwgYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc1Blcm1pc3Npb25zKGNoaWxkUm91dGUsIHN0YXRlKTtcbiAgICB9XG5cbiAgICBjYW5Mb2FkKHJvdXRlOiBSb3V0ZSk6IGJvb2xlYW4gfCBPYnNlcnZhYmxlPGJvb2xlYW4+IHwgUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc1Blcm1pc3Npb25zKHJvdXRlKTtcbiAgICB9XG5cbiAgICBjYW5NYXRjaChyb3V0ZTogUm91dGUpOiBib29sZWFuIHwgT2JzZXJ2YWJsZTxib29sZWFuPiB8IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNQZXJtaXNzaW9ucyhyb3V0ZSk7XG4gICAgfVxuXG4gICAgaGFzUGVybWlzc2lvbnMocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSwgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90KSB7XG4gICAgICAgIGNvbnN0IHJvdXRlRGF0YVBlcm1pc3Npb25zID0gISFyb3V0ZSAmJiByb3V0ZS5kYXRhID8gKHJvdXRlLmRhdGFbJ3Blcm1pc3Npb25zJ10gYXMgTmd4UGVybWlzc2lvbnNSb3V0ZXJEYXRhKSA6IHt9O1xuICAgICAgICBjb25zdCBwZXJtaXNzaW9ucyA9IHRoaXMudHJhbnNmb3JtUGVybWlzc2lvbihyb3V0ZURhdGFQZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcblxuICAgICAgICBpZiAodGhpcy5pc1BhcmFtZXRlckF2YWlsYWJsZShwZXJtaXNzaW9ucy5leGNlcHQpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYXNzaW5nRXhjZXB0UGVybWlzc2lvbnNWYWxpZGF0aW9uKHBlcm1pc3Npb25zLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuaXNQYXJhbWV0ZXJBdmFpbGFibGUocGVybWlzc2lvbnMub25seSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhc3NpbmdPbmx5UGVybWlzc2lvbnNWYWxpZGF0aW9uKHBlcm1pc3Npb25zLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cmFuc2Zvcm1QZXJtaXNzaW9uKFxuICAgICAgICBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNSb3V0ZXJEYXRhLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBOZ3hQZXJtaXNzaW9uc0RhdGEge1xuICAgICAgICBjb25zdCBvbmx5ID0gaXNGdW5jdGlvbjxPbmx5Rm4+KHBlcm1pc3Npb25zLm9ubHkpXG4gICAgICAgICAgICA/IHBlcm1pc3Npb25zLm9ubHkocm91dGUsIHN0YXRlKVxuICAgICAgICAgICAgOiB0cmFuc2Zvcm1TdHJpbmdUb0FycmF5KHBlcm1pc3Npb25zLm9ubHkpO1xuICAgICAgICBjb25zdCBleGNlcHQgPSBpc0Z1bmN0aW9uPEV4Y2VwdEZuPihwZXJtaXNzaW9ucy5leGNlcHQpXG4gICAgICAgICAgICA/IHBlcm1pc3Npb25zLmV4Y2VwdChyb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IHRyYW5zZm9ybVN0cmluZ1RvQXJyYXkocGVybWlzc2lvbnMuZXhjZXB0KTtcbiAgICAgICAgY29uc3QgcmVkaXJlY3RUbyA9IHBlcm1pc3Npb25zLnJlZGlyZWN0VG87XG5cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgb25seSxcbiAgICAgICAgICAgIGV4Y2VwdCxcbiAgICAgICAgICAgIHJlZGlyZWN0VG9cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzUGFyYW1ldGVyQXZhaWxhYmxlKHBlcm1pc3Npb246IHN0cmluZyB8IHN0cmluZ1tdKSB7XG4gICAgICAgIHJldHVybiAhIXBlcm1pc3Npb24gJiYgcGVybWlzc2lvbi5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFzc2luZ0V4Y2VwdFBlcm1pc3Npb25zVmFsaWRhdGlvbihcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSxcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgISFwZXJtaXNzaW9ucy5yZWRpcmVjdFRvXG4gICAgICAgICAgICAmJiAoXG4gICAgICAgICAgICAgICAgKGlzRnVuY3Rpb248UmVkaXJlY3RUb0ZuPihwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSlcbiAgICAgICAgICAgICAgICB8fCAoaXNQbGFpbk9iamVjdChwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSAmJiAhdGhpcy5pc1JlZGlyZWN0aW9uV2l0aFBhcmFtZXRlcnMocGVybWlzc2lvbnMucmVkaXJlY3RUbykpXG4gICAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgICAgbGV0IGZhaWxlZFBlcm1pc3Npb24gPSAnJztcblxuICAgICAgICAgICAgcmV0dXJuIGZyb20ocGVybWlzc2lvbnMuZXhjZXB0KVxuICAgICAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgICAgICBtZXJnZU1hcChwZXJtaXNzaW9uc0V4Y2VwdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm9ya0pvaW4oW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24ocGVybWlzc2lvbnNFeGNlcHQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm9sZXNTZXJ2aWNlLmhhc09ubHlSb2xlcyhwZXJtaXNzaW9uc0V4Y2VwdClcbiAgICAgICAgICAgICAgICAgICAgICAgIF0pLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFwKGhhc1Blcm1pc3Npb25zID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZG9udEhhdmVQZXJtaXNzaW9ucyA9IGhhc1Blcm1pc3Npb25zLmV2ZXJ5KGhhc1Blcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbiA9PT0gZmFsc2UpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZG9udEhhdmVQZXJtaXNzaW9ucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkUGVybWlzc2lvbiA9IHBlcm1pc3Npb25zRXhjZXB0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICBmaXJzdChoYXNQZXJtaXNzaW9ucyA9PiBoYXNQZXJtaXNzaW9ucy5zb21lKGhhc1Blcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbiA9PT0gdHJ1ZSksIGZhbHNlKSxcbiAgICAgICAgICAgICAgICAgICAgbWVyZ2VNYXAoaXNBbGxGYWxzZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoISFmYWlsZWRQZXJtaXNzaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVSZWRpcmVjdE9mRmFpbGVkUGVybWlzc2lvbihwZXJtaXNzaW9ucywgZmFpbGVkUGVybWlzc2lvbiwgcm91dGUsIHN0YXRlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNBbGxGYWxzZSAmJiBwZXJtaXNzaW9ucy5vbmx5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub25seVJlZGlyZWN0Q2hlY2socGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZighaXNBbGxGYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5oYXNQZXJtaXNzaW9uKHBlcm1pc3Npb25zLmV4Y2VwdCksXG4gICAgICAgICAgICB0aGlzLnJvbGVzU2VydmljZS5oYXNPbmx5Um9sZXMocGVybWlzc2lvbnMuZXhjZXB0KVxuICAgICAgICBdKS50aGVuKChbaGFzUGVybWlzc2lvbiwgaGFzUm9sZXNdKSA9PiB7XG4gICAgICAgICAgICBpZiAoaGFzUGVybWlzc2lvbiB8fCBoYXNSb2xlcykge1xuICAgICAgICAgICAgICAgIGlmIChwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVkaXJlY3RUb0Fub3RoZXJSb3V0ZShcbiAgICAgICAgICAgICAgICAgICAgICAgIHBlcm1pc3Npb25zLnJlZGlyZWN0VG8sXG4gICAgICAgICAgICAgICAgICAgICAgICByb3V0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocGVybWlzc2lvbnMub25seSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrT25seVBlcm1pc3Npb25zKHBlcm1pc3Npb25zLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVkaXJlY3RUb0Fub3RoZXJSb3V0ZShcbiAgICAgICAgcGVybWlzc2lvblJlZGlyZWN0VG86IFJlZGlyZWN0VG8gfCBSZWRpcmVjdFRvRm4sXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdCxcbiAgICAgICAgZmFpbGVkUGVybWlzc2lvbk5hbWU/OiBzdHJpbmdcbiAgICApOiB2b2lkIHtcblxuICAgICAgICBjb25zdCByZWRpcmVjdFRvID0gaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25SZWRpcmVjdFRvKVxuICAgICAgICAgICAgPyBwZXJtaXNzaW9uUmVkaXJlY3RUbyhmYWlsZWRQZXJtaXNzaW9uTmFtZSwgcm91dGUsIHN0YXRlKVxuICAgICAgICAgICAgOiBwZXJtaXNzaW9uUmVkaXJlY3RUbztcblxuICAgICAgICBpZiAodGhpcy5pc1JlZGlyZWN0aW9uV2l0aFBhcmFtZXRlcnMocmVkaXJlY3RUbykpIHtcbiAgICAgICAgICAgIHJlZGlyZWN0VG8ubmF2aWdhdGlvbkNvbW1hbmRzID0gdGhpcy50cmFuc2Zvcm1OYXZpZ2F0aW9uQ29tbWFuZHMocmVkaXJlY3RUby5uYXZpZ2F0aW9uQ29tbWFuZHMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgICAgICByZWRpcmVjdFRvLm5hdmlnYXRpb25FeHRyYXMgPSB0aGlzLnRyYW5zZm9ybU5hdmlnYXRpb25FeHRyYXMocmVkaXJlY3RUby5uYXZpZ2F0aW9uRXh0cmFzLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUocmVkaXJlY3RUby5uYXZpZ2F0aW9uQ29tbWFuZHMsIHJlZGlyZWN0VG8ubmF2aWdhdGlvbkV4dHJhcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZWRpcmVjdFRvKSkge1xuICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUocmVkaXJlY3RUbyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbcmVkaXJlY3RUb10pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1JlZGlyZWN0aW9uV2l0aFBhcmFtZXRlcnMob2JqZWN0OiBhbnkgfCBOZ3hSZWRpcmVjdFRvTmF2aWdhdGlvblBhcmFtZXRlcnMpOiBvYmplY3QgaXMgTmd4UmVkaXJlY3RUb05hdmlnYXRpb25QYXJhbWV0ZXJzIHtcbiAgICAgICAgcmV0dXJuIChpc1BsYWluT2JqZWN0KG9iamVjdCkgJiYgKCEhb2JqZWN0Lm5hdmlnYXRpb25Db21tYW5kcyB8fCAhIW9iamVjdC5uYXZpZ2F0aW9uRXh0cmFzKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cmFuc2Zvcm1OYXZpZ2F0aW9uQ29tbWFuZHMoXG4gICAgICAgIG5hdmlnYXRpb25Db21tYW5kczogYW55W10gfCBOYXZpZ2F0aW9uQ29tbWFuZHNGbixcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogYW55W10ge1xuICAgICAgICByZXR1cm4gaXNGdW5jdGlvbjxOYXZpZ2F0aW9uQ29tbWFuZHNGbj4obmF2aWdhdGlvbkNvbW1hbmRzKVxuICAgICAgICAgICAgPyBuYXZpZ2F0aW9uQ29tbWFuZHMocm91dGUsIHN0YXRlKVxuICAgICAgICAgICAgOiBuYXZpZ2F0aW9uQ29tbWFuZHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cmFuc2Zvcm1OYXZpZ2F0aW9uRXh0cmFzKFxuICAgICAgICBuYXZpZ2F0aW9uRXh0cmFzOiBOYXZpZ2F0aW9uRXh0cmFzIHwgTmF2aWdhdGlvbkV4dHJhc0ZuLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBOYXZpZ2F0aW9uRXh0cmFzIHtcbiAgICAgICAgcmV0dXJuIGlzRnVuY3Rpb248TmF2aWdhdGlvbkV4dHJhc0ZuPihuYXZpZ2F0aW9uRXh0cmFzKVxuICAgICAgICAgICAgPyBuYXZpZ2F0aW9uRXh0cmFzKHJvdXRlLCBzdGF0ZSlcbiAgICAgICAgICAgIDogbmF2aWdhdGlvbkV4dHJhcztcbiAgICB9XG5cbiAgICBwcml2YXRlIG9ubHlSZWRpcmVjdENoZWNrKFxuICAgICAgICBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgbGV0IGZhaWxlZFBlcm1pc3Npb24gPSAnJztcblxuICAgICAgICByZXR1cm4gZnJvbShwZXJtaXNzaW9ucy5vbmx5KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWVyZ2VNYXAocGVybWlzc2lvbnNPbmx5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcmtKb2luKFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLmhhc1Blcm1pc3Npb24ocGVybWlzc2lvbnNPbmx5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm9sZXNTZXJ2aWNlLmhhc09ubHlSb2xlcyhwZXJtaXNzaW9uc09ubHkpXG4gICAgICAgICAgICAgICAgICAgIF0pLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXAoaGFzUGVybWlzc2lvbnMgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhaWxlZCA9IGhhc1Blcm1pc3Npb25zLmV2ZXJ5KGhhc1Blcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbiA9PT0gZmFsc2UpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZhaWxlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWRQZXJtaXNzaW9uID0gcGVybWlzc2lvbnNPbmx5O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgZmlyc3QoaGFzUGVybWlzc2lvbnMgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb248UmVkaXJlY3RUb0ZuPihwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNQZXJtaXNzaW9ucy5zb21lKGhhc1Blcm1pc3Npb24gPT4gaGFzUGVybWlzc2lvbiA9PT0gdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNQZXJtaXNzaW9ucy5ldmVyeShoYXNQZXJtaXNzaW9uID0+IGhhc1Blcm1pc3Npb24gPT09IGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgZmFsc2UpLFxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKFxuICAgICAgICAgICAgICAgICAgICAocGFzczogYm9vbGVhbik6IE9ic2VydmFibGU8Ym9vbGVhbj4gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb248UmVkaXJlY3RUb0ZuPihwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXNzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVJlZGlyZWN0T2ZGYWlsZWRQZXJtaXNzaW9uKHBlcm1pc3Npb25zLCBmYWlsZWRQZXJtaXNzaW9uLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEhZmFpbGVkUGVybWlzc2lvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVJlZGlyZWN0T2ZGYWlsZWRQZXJtaXNzaW9uKHBlcm1pc3Npb25zLCBmYWlsZWRQZXJtaXNzaW9uLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoIXBhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlUmVkaXJlY3RPZkZhaWxlZFBlcm1pc3Npb24oXG4gICAgICAgIHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEsXG4gICAgICAgIGZhaWxlZFBlcm1pc3Npb246IHN0cmluZyxcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKSB7XG4gICAgICAgIGlmICh0aGlzLmlzRmFpbGVkUGVybWlzc2lvblByb3BlcnR5T2ZSZWRpcmVjdFRvKHBlcm1pc3Npb25zLCBmYWlsZWRQZXJtaXNzaW9uKSkge1xuICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKHBlcm1pc3Npb25zLnJlZGlyZWN0VG9bZmFpbGVkUGVybWlzc2lvbl0sIHJvdXRlLCBzdGF0ZSwgZmFpbGVkUGVybWlzc2lvbik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvQW5vdGhlclJvdXRlKHBlcm1pc3Npb25zLnJlZGlyZWN0VG8sIHJvdXRlLCBzdGF0ZSwgZmFpbGVkUGVybWlzc2lvbik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMucmVkaXJlY3RUb0Fub3RoZXJSb3V0ZShwZXJtaXNzaW9ucy5yZWRpcmVjdFRvW0RFRkFVTFRfUkVESVJFQ1RfS0VZXSwgcm91dGUsIHN0YXRlLCBmYWlsZWRQZXJtaXNzaW9uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNGYWlsZWRQZXJtaXNzaW9uUHJvcGVydHlPZlJlZGlyZWN0VG8ocGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSwgZmFpbGVkUGVybWlzc2lvbjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoISFwZXJtaXNzaW9ucy5yZWRpcmVjdFRvICYmIHBlcm1pc3Npb25zLnJlZGlyZWN0VG9bZmFpbGVkUGVybWlzc2lvbl0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2hlY2tPbmx5UGVybWlzc2lvbnMoXG4gICAgICAgIHB1cmVQZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSA9IHtcbiAgICAgICAgICAgIC4uLnB1cmVQZXJtaXNzaW9uc1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5oYXNQZXJtaXNzaW9uKHBlcm1pc3Npb25zLm9ubHkpLFxuICAgICAgICAgICAgdGhpcy5yb2xlc1NlcnZpY2UuaGFzT25seVJvbGVzKHBlcm1pc3Npb25zLm9ubHkpXG4gICAgICAgIF0pLnRoZW4oKFtoYXNQZXJtaXNzaW9uLCBoYXNSb2xlXSkgPT4ge1xuICAgICAgICAgICAgaWYgKGhhc1Blcm1pc3Npb24gfHwgaGFzUm9sZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocGVybWlzc2lvbnMucmVkaXJlY3RUbykge1xuICAgICAgICAgICAgICAgIHRoaXMucmVkaXJlY3RUb0Fub3RoZXJSb3V0ZShwZXJtaXNzaW9ucy5yZWRpcmVjdFRvLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFzc2luZ09ubHlQZXJtaXNzaW9uc1ZhbGlkYXRpb24oXG4gICAgICAgIHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEsXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAoaXNGdW5jdGlvbjxSZWRpcmVjdFRvRm4+KHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pXG4gICAgICAgICAgICAgICAgfHwgaXNQbGFpbk9iamVjdChwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSAmJiAhdGhpcy5pc1JlZGlyZWN0aW9uV2l0aFBhcmFtZXRlcnMocGVybWlzc2lvbnMucmVkaXJlY3RUbykpXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMub25seVJlZGlyZWN0Q2hlY2socGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tPbmx5UGVybWlzc2lvbnMocGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG4gICAgfVxufVxuIl19